<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSI Watchlist</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --line:rgba(148,163,184,.25); --btn:#2563eb; --btn2:#334155;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --radius:14px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    h1{margin:0 0 16px 0; font-size:22px}
    .grid{display:grid; grid-template-columns: 1.2fr 2fr; gap:14px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, button, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(2,6,23,.35); color:var(--text); outline:none;
    }
    input[type="date"]{padding:9px 12px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:0}
    .primary{background:var(--btn)}
    .secondary{background:var(--btn2)}
    .danger{background:var(--bad)}
    .mono{font-family:var(--mono); font-size:12px}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--line)}
    th, td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:middle}
    th{font-size:12px; color:var(--muted); text-align:left; background:rgba(148,163,184,.06)}
    tr:last-child td{border-bottom:0}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line)}
    .tag.ok{border-color:rgba(22,163,74,.45); color:#86efac}
    .tag.bad{border-color:rgba(239,68,68,.45); color:#fecaca}
    .small{font-size:12px; color:var(--muted)}
    .right{display:flex; justify-content:flex-end}
    .sticky-actions{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
    .notice{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(148,163,184,.06); color:var(--muted); font-size:12px}
    .error{color:#fecaca}
    .oktext{color:#86efac}

    /* Tabs + Watchlist editor */
    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{background:var(--btn2); padding:10px 12px; border-radius:12px; border:1px solid var(--line); cursor:pointer; user-select:none}
    .tab.active{background:var(--btn); border-color:rgba(37,99,235,.35)}
    .view{display:none}
    .view.active{display:block}
    .wl-grid{display:grid; grid-template-columns: 1fr 1fr 120px; gap:10px}
    .wl-row{display:grid; grid-template-columns: 140px 1fr 120px; gap:10px; align-items:center}
    .wl-row input{width:100%}
    .smallbtn{padding:10px 12px; border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>RSI Watchlist</h1>

  <div class="grid">
    <!-- LEFT CARD -->
    <div class="card">
      <div class="row">
        <div>
          <label>Дата (торговый день)</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>GitHub token (Contents: Read &amp; Write)</label>
          <input id="token" type="password" placeholder="fine-grained token" />
          <div class="small">Токен не в коде. Можно сохранить в браузере.</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row3">
        <div>
          <label>Owner</label>
          <input id="owner" value="mariiashumova1979-collab" />
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" value="rsi-watchlist" />
        </div>
        <div>
          <label>Файл истории</label>
          <input id="path" value="data/history.json" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="btns">
        <button class="secondary" id="load">Load history from Git (sha)</button>
        <button class="secondary" id="saveToken">Save token (local)</button>
        <button class="danger" id="clearToken">Clear token</button>
      </div>

      <div style="height:10px"></div>
      <div id="status" class="notice mono">Status: idle</div>

      <div style="height:14px"></div>
      <div class="notice">
        Правила сигнала:
        <div class="mono" style="margin-top:6px">
          LONG: RSI7 crossed ↑20 (вчера &lt;=20, сегодня &gt;20) и RSI14 &lt; 40<br/>
          SHORT: RSI7 crossed ↓80 (вчера &gt;=80, сегодня &lt;80) и RSI14 &gt; 60
        </div>
        <div class="small" style="margin-top:8px">
          RSI7 вчера берётся из предыдущей даты в history.json (date-1).
        </div>
      </div>
    </div>

    <!-- RIGHT CARD WITH TABS -->
    <div class="card">

      <div class="tabs" style="margin-bottom:12px">
        <div class="tab active" id="tabScanner">Scanner</div>
        <div class="tab" id="tabWatchlist">Watchlist</div>
      </div>

      <!-- VIEW: SCANNER -->
      <div class="view active" id="viewScanner">
        <div class="sticky-actions">
          <div class="small" id="meta"></div>
          <div class="btns">
            <button class="secondary" id="exportDay">Export day JSON</button>
            <button class="primary" id="saveGit">Save day to GitHub</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <table>
          <thead>
          <tr>
            <th style="width:120px">Ticker</th>
            <th style="width:110px">RSI7 today</th>
            <th style="width:110px">RSI14 today</th>
            <th style="width:110px">RSI7 вчера</th>
            <th style="width:120px">Signal</th>
            <th style="width:110px">Pick</th>
            <th>Notes</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div style="height:10px"></div>
        <div class="right small">Изменения остаются в браузере до “Save day to GitHub”.</div>
      </div>

      <!-- VIEW: WATCHLIST -->
      <div class="view" id="viewWatchlist">
        <div class="notice">
          Здесь редактируется <span class="mono">data/watchlist.json</span>.
          История (<span class="mono">history.json</span>) не трогается.
        </div>

        <div style="height:12px"></div>

        <div class="wl-grid">
          <div>
            <label>Ticker</label>
            <input id="wlNewTicker" placeholder="например, META" />
          </div>
          <div>
            <label>Sector</label>
            <input id="wlNewSector" placeholder="например, Tech" />
          </div>
          <div style="display:flex; align-items:end">
            <button class="secondary smallbtn" id="wlAdd">+ Add</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="sticky-actions">
          <div class="small" id="wlMeta"></div>
          <div class="btns">
            <button class="secondary" id="wlReload">Reload watchlist (sha)</button>
            <button class="primary" id="wlSave">Save watchlist to GitHub</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <div id="wlList" style="display:flex; flex-direction:column; gap:10px"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // Raw URLs (read-only)
  const WATCHLIST_URL = "https://raw.githubusercontent.com/mariiashumova1979-collab/rsi-watchlist/refs/heads/main/data/watchlist.json";
  const HISTORY_RAW   = "https://raw.githubusercontent.com/mariiashumova1979-collab/rsi-watchlist/refs/heads/main/data/history.json";

  const $ = (id)=>document.getElementById(id);

  const state = {
    watchlist: [],
    history: null,
    date: null,
    dayRows: [],
    historySha: null,
    watchlistObj: null,
    watchlistSha: null
  };

  function setStatus(msg, type="") {
    const el = $("status");
    el.textContent = "Status: " + msg;
    el.classList.remove("error","oktext");
    if (type==="error") el.classList.add("error");
    if (type==="ok") el.classList.add("oktext");
  }

  function fmtDate(d){ return d.toISOString().slice(0,10); }

  function prevDateStr(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    d.setDate(d.getDate()-1);
    return fmtDate(d);
  }

  function safeNum(v){
    if (v===null || v===undefined || v==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function computeSignal(rsi7Today, rsi14Today, rsi7Prev){
    if (rsi7Today==null || rsi14Today==null || rsi7Prev==null) return "";
    const long = (rsi7Prev <= 20 && rsi7Today > 20 && rsi14Today < 40);
    const short = (rsi7Prev >= 80 && rsi7Today < 80 && rsi14Today > 60);
    if (long) return "LONG";
    if (short) return "SHORT";
    return "";
  }

  function signalTag(signal){
    if (signal==="LONG") return `<span class="tag ok">LONG</span>`;
    if (signal==="SHORT") return `<span class="tag bad">SHORT</span>`;
    return `<span class="tag">—</span>`;
  }

  async function loadWatchlistRaw(){
    const res = await fetch(WATCHLIST_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Watchlist not loaded");
    const data = await res.json();
    return (data.tickers || []).map(x => ({
      ticker: (x.ticker || "").toUpperCase().trim(),
      sector: (x.sector || "").trim()
    }));
  }

  async function loadHistoryRaw(){
    const res = await fetch(HISTORY_RAW, { cache:"no-store" });
    if (!res.ok) throw new Error("History not loaded");
    return await res.json();
  }

  function ensureBaseHistory(h){
    if (!h || typeof h !== "object") h = {};
    if (!h.meta) h.meta = { timezone: "Europe/Nicosia" };
    if (!h.days) h.days = {};
    return h;
  }

  function buildDayRows(dateStr){
    const prev = prevDateStr(dateStr);
    const prevRows = (state.history.days[prev] || []);
    const prevMap = new Map(prevRows.map(r => [r.ticker, r.rsi7_prev ?? r.rsi7 ?? null])); // tolerate old formats

    const todayExisting = (state.history.days[dateStr] || []);
    const todayMap = new Map(todayExisting.map(r => [r.ticker, r]));

    const rows = state.watchlist.map(w => {
      const t = (w.ticker || "").toUpperCase().trim();
      const existing = todayMap.get(t) || {};
      const rsi7prev = prevMap.has(t) ? prevMap.get(t) : (existing.rsi7_prev ?? null);
      const rsi7 = existing.rsi7 ?? null;
      const rsi14 = existing.rsi14 ?? null;
      const pick = existing.pick ?? "";
      const notes = existing.notes ?? "";
      const signal = computeSignal(rsi7, rsi14, rsi7prev);
      return { ticker:t, rsi7, rsi14, rsi7_prev:rsi7prev, signal, pick, notes };
    });

    state.dayRows = rows;
    renderTable();
    $("meta").textContent = `Loaded: ${state.watchlist.length} tickers | Date: ${dateStr} | Prev date: ${prev}`;
  }

  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = state.dayRows.map((r, idx)=>`
      <tr data-idx="${idx}">
        <td class="mono">${r.ticker}</td>
        <td><input inputmode="decimal" value="${r.rsi7 ?? ""}" data-k="rsi7" /></td>
        <td><input inputmode="decimal" value="${r.rsi14 ?? ""}" data-k="rsi14" /></td>
        <td class="mono">${r.rsi7_prev ?? ""}</td>
        <td>${signalTag(r.signal)}</td>
        <td>
          <select data-k="pick">
            <option value="" ${r.pick===""?"selected":""}>—</option>
            <option value="YES" ${r.pick==="YES"?"selected":""}>YES</option>
            <option value="WAIT" ${r.pick==="WAIT"?"selected":""}>WAIT</option>
            <option value="NO" ${r.pick==="NO"?"selected":""}>NO</option>
          </select>
        </td>
        <td><input value="${(r.notes||"").replaceAll('"',"&quot;")}" data-k="notes" /></td>
      </tr>
    `).join("");

    tb.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("change", (e)=>{
        const tr = e.target.closest("tr");
        const idx = Number(tr.dataset.idx);
        const key = e.target.dataset.k;
        if (key === "rsi7" || key === "rsi14") {
          state.dayRows[idx][key] = safeNum(e.target.value);
        } else {
          state.dayRows[idx][key] = e.target.value;
        }
        const r = state.dayRows[idx];
        r.signal = computeSignal(r.rsi7, r.rsi14, r.rsi7_prev);
        tr.children[4].innerHTML = signalTag(r.signal);
      });
    });
  }

  function renderWatchlist(){
    const root = $("wlList");
    $("wlMeta").textContent = `Tickers: ${state.watchlist.length}`;
    root.innerHTML = "";

    state.watchlist.forEach((w, idx) => {
      const row = document.createElement("div");
      row.className = "wl-row";
      row.dataset.idx = String(idx);
      row.innerHTML = `
        <input class="mono" data-k="ticker" value="${(w.ticker||"").replaceAll('"',"&quot;")}" />
        <input data-k="sector" value="${(w.sector||"").replaceAll('"',"&quot;")}" />
        <button class="danger smallbtn" data-act="del">Delete</button>
      `;
      root.appendChild(row);
    });

    root.querySelectorAll("input").forEach(el=>{
      el.addEventListener("change", (e)=>{
        const row = e.target.closest(".wl-row");
        const idx = Number(row.dataset.idx);
        const key = e.target.dataset.k;
        state.watchlist[idx][key] = (e.target.value || "").trim();
        if(key === "ticker") state.watchlist[idx].ticker = state.watchlist[idx].ticker.toUpperCase().trim();
      });
    });

    root.querySelectorAll("button[data-act='del']").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const row = e.target.closest(".wl-row");
        const idx = Number(row.dataset.idx);
        state.watchlist.splice(idx, 1);
        renderWatchlist();
      });
    });
  }

  function getAuthToken(){
    return $("token").value.trim() || localStorage.getItem("gh_token") || "";
  }

  function saveToken(){
    const t = $("token").value.trim();
    if (!t) { setStatus("token empty", "error"); return; }
    localStorage.setItem("gh_token", t);
    setStatus("token saved locally", "ok");
  }

  function clearToken(){
    localStorage.removeItem("gh_token");
    $("token").value = "";
    setStatus("token cleared", "ok");
  }

  async function githubGetFile(owner, repo, path){
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const token = getAuthToken();
    const res = await fetch(url, {
      headers: {
        "Accept": "application/vnd.github+json",
        ...(token ? { "Authorization": "Bearer " + token } : {})
      }
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`GitHub GET failed: ${res.status} ${txt}`);
    }
    return await res.json(); // includes content + sha
  }

  async function githubPutFile(owner, repo, path, contentObj, sha, message){
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const token = getAuthToken();
    if (!token) throw new Error("No GitHub token provided");

    const body = {
      message: message || `Update ${path}`,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2)))),
      sha
    };

    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`GitHub PUT failed: ${res.status} ${txt}`);
    }
    return await res.json();
  }

  async function loadWatchlistFromGit(){
    const owner = $("owner").value.trim();
    const repo  = $("repo").value.trim();
    const path  = "data/watchlist.json";

    const file = await githubGetFile(owner, repo, path);
    const decoded = decodeURIComponent(escape(atob(file.content.replaceAll("\n",""))));
    const obj = JSON.parse(decoded);

    state.watchlistSha = file.sha;
    state.watchlistObj = obj;

    state.watchlist = (obj.tickers || []).map(x => ({
      ticker: (x.ticker || "").toUpperCase().trim(),
      sector: (x.sector || "").trim()
    }));
  }

  async function saveWatchlistToGit(){
    const owner = $("owner").value.trim();
    const repo  = $("repo").value.trim();
    const path  = "data/watchlist.json";

    if(!state.watchlistSha){
      throw new Error("No watchlist sha. Click 'Reload watchlist (sha)' first.");
    }

    const obj = state.watchlistObj && typeof state.watchlistObj === "object"
      ? state.watchlistObj
      : { tickers: [] };

    obj.tickers = state.watchlist.map(w => ({
      ticker: (w.ticker || "").toUpperCase().trim(),
      sector: (w.sector || "").trim()
    }));

    const resp = await githubPutFile(owner, repo, path, obj, state.watchlistSha, "Update watchlist");
    state.watchlistSha = resp.content.sha;
    state.watchlistObj = obj;

    // update scanner
    buildDayRows(state.date);
  }

  // Tabs
  function setTab(name){
    const scannerOn = name === "scanner";
    $("tabScanner").classList.toggle("active", scannerOn);
    $("tabWatchlist").classList.toggle("active", !scannerOn);
    $("viewScanner").classList.toggle("active", scannerOn);
    $("viewWatchlist").classList.toggle("active", !scannerOn);
  }

  // Actions
  $("saveToken").addEventListener("click", saveToken);
  $("clearToken").addEventListener("click", clearToken);

  $("tabScanner").addEventListener("click", ()=>setTab("scanner"));
  $("tabWatchlist").addEventListener("click", ()=>{
    setTab("watchlist");
    renderWatchlist();
    setStatus("watchlist opened. To save, click Reload watchlist (sha) first (needs token).", "ok");
  });

  $("wlAdd").addEventListener("click", ()=>{
    const t = $("wlNewTicker").value.trim();
    const s = $("wlNewSector").value.trim();
    if(!t) return;
    state.watchlist.unshift({ ticker: t.toUpperCase().trim(), sector: s });
    $("wlNewTicker").value = "";
    $("wlNewSector").value = "";
    renderWatchlist();
  });

  $("wlReload").addEventListener("click", async ()=>{
    try{
      setStatus("loading watchlist from GitHub API (sha acquired)...", "");
      await loadWatchlistFromGit();
      renderWatchlist();
      setStatus("watchlist loaded via GitHub API. You can save now.", "ok");
    } catch(e){
      setStatus(e.message, "error");
    }
  });

  $("wlSave").addEventListener("click", async ()=>{
    try{
      setStatus("saving watchlist to GitHub...", "");
      await saveWatchlistToGit();
      setStatus("watchlist saved to GitHub", "ok");
    } catch(e){
      setStatus(e.message, "error");
    }
  });

  $("date").addEventListener("change", async ()=>{
    try{
      state.date = $("date").value;
      state.history = ensureBaseHistory(await loadHistoryRaw());
      buildDayRows(state.date);
      setStatus("date changed; refreshed history raw", "ok");
    } catch(e){
      setStatus(e.message, "error");
    }
  });

  $("exportDay").addEventListener("click", ()=>{
    const dateStr = state.date;
    const payload = { [dateStr]: state.dayRows.filter(r => r.rsi7!=null || r.rsi14!=null || r.pick || r.notes) };
    navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    setStatus("day JSON copied to clipboard", "ok");
  });

  // History (day) load/save via GitHub API
  $("load").addEventListener("click", async ()=>{
    try{
      setStatus("loading history.json from GitHub API (sha acquired)...", "");
      const owner = $("owner").value.trim();
      const repo  = $("repo").value.trim();
      const path  = $("path").value.trim();

      const file = await githubGetFile(owner, repo, path);
      state.historySha = file.sha;

      const decoded = decodeURIComponent(escape(atob(file.content.replaceAll("\n",""))));
      state.history = ensureBaseHistory(JSON.parse(decoded));

      buildDayRows(state.date);
      setStatus("history loaded via GitHub API. You can save day now.", "ok");
    } catch(e){
      setStatus(e.message, "error");
    }
  });

  $("saveGit").addEventListener("click", async ()=>{
    try{
      const owner = $("owner").value.trim();
      const repo  = $("repo").value.trim();
      const path  = $("path").value.trim();

      if (!state.historySha) {
        throw new Error("No history sha. Click 'Load history from Git (sha)' first.");
      }

      const cleaned = state.dayRows
        .filter(r => r.rsi7!=null || r.rsi14!=null || r.pick || r.notes)
        .map(r => ({
          ticker: r.ticker,
          rsi7: r.rsi7,
          rsi14: r.rsi14,
          rsi7_prev: r.rsi7_prev,
          signal: r.signal || "",
          pick: r.pick || "",
          notes: r.notes || ""
        }));

      state.history.days[state.date] = cleaned;

      setStatus("saving day to GitHub...", "");
      const resp = await githubPutFile(owner, repo, path, state.history, state.historySha, `Update history ${state.date}`);
      state.historySha = resp.content.sha;
      setStatus("day saved to GitHub successfully", "ok");
    } catch(e){
      setStatus(e.message, "error");
    }
  });

  async function init(){
    // default date today
    const today = new Date();
    $("date").value = fmtDate(today);
    state.date = $("date").value;

    // preload token if exists
    const t = localStorage.getItem("gh_token");
    if (t) $("token").value = t;

    setStatus("loading raw watchlist + raw history...");
    state.watchlist = await loadWatchlistRaw();
    state.history = ensureBaseHistory(await loadHistoryRaw());
    buildDayRows(state.date);
    $("wlMeta").textContent = `Tickers: ${state.watchlist.length}`;
    setStatus("loaded from raw GitHub. For saving to GitHub, load sha via API buttons.", "ok");
  }

  init().catch(e => setStatus(e.message, "error"));
</script>
</body>
</html>
