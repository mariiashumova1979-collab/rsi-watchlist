<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSI Swing Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:    #0a0a12;
  --bg2:   #12121e;
  --bg3:   #1a1a2a;
  --bg4:   #222236;
  --line:  #2a2a42;
  --acc:   #7ee8a2;
  --acc2:  #ff6b8a;
  --acc3:  #ffc85a;
  --acc4:  #5b9cf6;
  --acc5:  #c084fc;
  --text:  #f0f0f8;
  --t2:    #9090b0;
  --t3:    #505070;
  --mono:  'JetBrains Mono', monospace;
  --sans:  'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5}

/* NOISE TEXTURE */
body::after{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:9999;opacity:0.35
}

/* CLOUD SYNC BANNER */
#syncBanner{
  position:fixed;top:0;left:0;right:0;z-index:500;
  background:linear-gradient(90deg,var(--acc4),var(--acc5));
  color:#fff;font-family:var(--mono);font-size:11px;
  padding:8px 20px;display:flex;align-items:center;justify-content:space-between;
  transform:translateY(-100%);transition:transform 0.3s;letter-spacing:.5px
}
#syncBanner.show{transform:translateY(0)}
#syncBanner.error{background:linear-gradient(90deg,var(--acc2),#c0392b)}

/* HEADER */
header{
  position:sticky;top:0;z-index:200;
  background:rgba(7,7,16,.96);backdrop-filter:blur(24px);
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:60px;
}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{
  width:32px;height:32px;border-radius:6px;
  background:linear-gradient(135deg,var(--acc),var(--acc4));
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:11px;font-weight:700;color:#070710
}
.logo-name{font-size:16px;font-weight:800;letter-spacing:-.5px}
.logo-ver{font-family:var(--mono);font-size:10px;color:var(--t2);letter-spacing:1px}
.header-right{display:flex;align-items:center;gap:12px}
.sync-dot{
  width:8px;height:8px;border-radius:50%;background:var(--t3);
  transition:background .3s;position:relative
}
.sync-dot.synced{background:var(--acc)}
.sync-dot.syncing{background:var(--acc3);animation:pulse 1s infinite}
.sync-dot.error{background:var(--acc2)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.sync-label{font-family:var(--mono);font-size:10px;color:var(--t2);letter-spacing:.5px}

/* NAV */
nav{
  background:var(--bg2);border-bottom:1px solid var(--line);
  display:flex;padding:0 24px;overflow-x:auto;
  scrollbar-width:none;-ms-overflow-style:none
}
nav::-webkit-scrollbar{display:none}
.ntab{
  padding:14px 18px;font-size:12px;font-weight:700;
  color:var(--t2);cursor:pointer;white-space:nowrap;
  border-bottom:2px solid transparent;transition:all .2s;
  letter-spacing:.3px;display:flex;align-items:center;gap:6px
}
.ntab:hover{color:var(--text)}
.ntab.active{color:var(--acc);border-bottom-color:var(--acc)}

/* MAIN */
main{padding:28px 24px;max-width:1360px;margin:0 auto;position:relative;z-index:1}
.tab{display:none}.tab.active{display:block}

/* LOADING OVERLAY ‚Äî hidden, UI renders instantly */
#loadingOverlay{ display:none !important; }


/* CARDS */
.card{background:var(--bg2);border:1px solid var(--line);border-radius:12px;padding:22px}
.card+.card{margin-top:16px}
.card-sm{padding:16px}

/* GRID HELPERS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.gauto{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
@media(max-width:800px){.g2,.g3,.g4{grid-template-columns:1fr}}

/* STAT CARDS */
.stat{
  background:var(--bg2);border:1px solid var(--line);
  border-radius:10px;padding:18px 20px;position:relative;overflow:hidden
}
.stat::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--sc,var(--acc))
}
.stat-l{font-family:var(--mono);font-size:10px;color:var(--t2);letter-spacing:1.2px;text-transform:uppercase;margin-bottom:6px}
.stat-v{font-size:26px;font-weight:800;letter-spacing:-1px;line-height:1}
.stat-s{font-family:var(--mono);font-size:10px;color:var(--t2);margin-top:4px}

/* SECTION HEADS */
.sh{
  font-family:var(--mono);font-size:10px;font-weight:700;
  color:var(--t2);letter-spacing:2px;text-transform:uppercase;
  margin-bottom:14px;display:flex;align-items:center;gap:10px
}
.sh::after{content:'';flex:1;height:1px;background:var(--line)}

/* FORMS */
.fg{display:flex;flex-direction:column;gap:6px}
.fg.full{grid-column:1/-1}
label{font-family:var(--mono);font-size:10px;font-weight:700;color:var(--t2);letter-spacing:1px;text-transform:uppercase}
input,select,textarea{
  background:var(--bg3);border:1px solid var(--line);border-radius:8px;
  padding:9px 13px;color:var(--text);font-family:var(--mono);font-size:12px;
  outline:none;transition:border-color .2s;width:100%
}
input:focus,select:focus,textarea:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(126,232,162,.08)}
select option{background:var(--bg3)}
textarea{resize:vertical;min-height:72px}
.fgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}

/* BUTTONS */
.btn{
  padding:9px 18px;border-radius:8px;font-family:var(--mono);font-size:11px;
  font-weight:700;letter-spacing:.8px;cursor:pointer;border:1px solid;
  transition:all .2s;text-transform:uppercase;display:inline-flex;align-items:center;gap:6px
}
.btn-p{background:var(--acc);color:var(--bg);border-color:var(--acc)}
.btn-p:hover{background:transparent;color:var(--acc)}
.btn-d{background:transparent;color:var(--acc2);border-color:var(--acc2)}
.btn-d:hover{background:rgba(255,107,138,.1)}
.btn-g{background:transparent;color:var(--t2);border-color:var(--line)}
.btn-g:hover{color:var(--text);border-color:var(--t2)}
.btn-s{padding:6px 12px;font-size:10px}
.btn-sync{background:linear-gradient(135deg,var(--acc4),var(--acc5));color:#fff;border:none}
.btn-sync:hover{opacity:.85}

/* BADGES */
.b{padding:3px 9px;border-radius:20px;font-size:9px;font-weight:700;font-family:var(--mono);letter-spacing:.5px;display:inline-block}
.b-long{background:rgba(126,232,162,.15);color:var(--acc)}
.b-short{background:rgba(255,107,138,.15);color:var(--acc2)}
.b-open{background:rgba(91,156,246,.15);color:var(--acc4)}
.b-win{background:rgba(126,232,162,.15);color:var(--acc)}
.b-loss{background:rgba(255,107,138,.15);color:var(--acc2)}
.b-warn{background:rgba(255,200,90,.15);color:var(--acc3)}

/* TABLE */
.tw{overflow-x:auto;border-radius:10px;border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:12px}
th{
  text-align:left;padding:10px 14px;
  font-family:var(--mono);font-size:9px;font-weight:700;
  color:var(--t2);letter-spacing:1.5px;text-transform:uppercase;
  border-bottom:1px solid var(--line);background:var(--bg3);white-space:nowrap
}
td{padding:11px 14px;border-bottom:1px solid rgba(35,35,56,.5);font-family:var(--mono);font-size:11px;vertical-align:middle;white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(126,232,162,.02)}

/* COLORS */
.g{color:var(--acc)}.r{color:var(--acc2)}.y{color:var(--acc3)}.bl{color:var(--acc4)}

/* DAY BADGES */
.db{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;font-size:10px;font-weight:700;font-family:var(--mono)}
.d1{background:rgba(91,156,246,.2);color:var(--acc4)}
.d2{background:rgba(91,156,246,.3);color:var(--acc4)}
.d3{background:rgba(255,200,90,.2);color:var(--acc3)}
.d4{background:rgba(255,200,90,.35);color:var(--acc3)}
.d5{background:rgba(255,107,138,.25);color:var(--acc2);border:1px solid var(--acc2)}

/* CHECKLIST */
.cl{display:flex;flex-direction:column;gap:7px}
.ci{
  display:flex;align-items:flex-start;gap:10px;
  padding:9px 12px;border-radius:8px;
  background:var(--bg3);border:1px solid var(--line);
  cursor:pointer;transition:all .2s
}
.ci:hover{border-color:rgba(126,232,162,.3)}
.ci.chk{background:rgba(126,232,162,.04);border-color:rgba(126,232,162,.2)}
.ci.chk .cit{color:var(--t2);text-decoration:line-through}
.cbox{
  width:17px;height:17px;border:2px solid var(--line);border-radius:4px;
  flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;transition:all .2s
}
.ci.chk .cbox{background:var(--acc);border-color:var(--acc)}
.cbox::after{content:'‚úì';color:var(--bg);font-size:10px;font-weight:700;opacity:0;transition:opacity .2s}
.ci.chk .cbox::after{opacity:1}
.cit{font-size:12px;color:var(--text);line-height:1.4}
.csec{font-family:var(--mono);font-size:9px;color:var(--acc);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin:14px 0 7px}

/* MODAL */
.mo{
  position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;
  display:flex;align-items:center;justify-content:center;padding:20px;
  opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(6px)
}
.mo.open{opacity:1;pointer-events:all}
.md{
  background:var(--bg2);border:1px solid var(--line);border-radius:14px;
  padding:28px;width:100%;max-width:680px;max-height:92vh;overflow-y:auto;
  transform:translateY(16px);transition:transform .2s;
  scrollbar-width:thin;scrollbar-color:var(--line) transparent
}
.mo.open .md{transform:translateY(0)}
.mh{font-size:18px;font-weight:800;margin-bottom:22px;display:flex;justify-content:space-between;align-items:center}
.mclose{cursor:pointer;color:var(--t2);font-size:18px;transition:color .2s}
.mclose:hover{color:var(--acc2)}

/* WATCHLIST */
.wgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:10px}
.wi{
  background:var(--bg3);border:1px solid var(--line);border-radius:10px;
  padding:13px;position:relative;transition:all .2s
}
.wi:hover{border-color:rgba(126,232,162,.4)}
.wi.bo{opacity:.55;border-color:rgba(255,107,138,.4)}
.wi.cd{border-color:rgba(255,200,90,.3)}
.wi.op{border-color:var(--acc4);background:rgba(91,156,246,.08)}
.wt{font-size:15px;font-weight:800;margin-bottom:3px}
.wm{font-family:var(--mono);font-size:9px;color:var(--t2);margin-bottom:6px}
.wr{position:absolute;top:8px;right:8px;background:none;border:none;cursor:pointer;color:var(--t3);font-size:13px;transition:color .2s}
.wr:hover{color:var(--acc2)}

/* TOAST */
#toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--acc);color:var(--bg);
  padding:11px 18px;border-radius:8px;
  font-family:var(--mono);font-size:11px;font-weight:700;
  z-index:9998;opacity:0;transform:translateY(8px);
  transition:all .25s;pointer-events:none;letter-spacing:.5px
}
#toast.show{opacity:1;transform:translateY(0)}
#toast.err{background:var(--acc2)}

/* RSI INPUT IN TABLE */
.rsi-inp{
  width:60px;padding:4px 6px;border-radius:5px;
  background:var(--bg4);border:1px solid var(--line);
  color:var(--text);font-family:var(--mono);font-size:11px;
  text-align:center;outline:none;transition:border-color .2s
}
.rsi-inp:focus{border-color:var(--acc)}

/* RSI MINI BAR */
.rsi-bar-wrap{display:flex;align-items:center;gap:6px}
.rsi-mini{width:60px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;flex-shrink:0}
.rsi-mini-fill{height:100%;border-radius:3px;transition:width .3s,background .3s}
.rsi-val{font-family:var(--mono);font-size:10px;font-weight:700;min-width:28px}

/* SIGNAL BADGE */
.sig-long{background:rgba(126,232,162,.2);color:var(--acc);border:1px solid rgba(126,232,162,.4);padding:3px 10px;border-radius:20px;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px}
.sig-short{background:rgba(255,107,138,.2);color:var(--acc2);border:1px solid rgba(255,107,138,.4);padding:3px 10px;border-radius:20px;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px}
.sig-watch{background:rgba(255,200,90,.15);color:var(--acc3);border:1px solid rgba(255,200,90,.3);padding:3px 10px;border-radius:20px;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px}
.sig-position{background:rgba(91,156,246,.2);color:var(--acc4);border:1px solid rgba(91,156,246,.4);padding:3px 10px;border-radius:20px;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px}
.sig-none{color:var(--t3);font-family:var(--mono);font-size:10px}

/* SIGNAL CARD ON DASHBOARD */
.sig-card{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;border-radius:10px;border:1px solid;
  background:var(--bg3);margin-bottom:8px
}
.sig-card.long{border-color:rgba(126,232,162,.3)}
.sig-card.short{border-color:rgba(255,107,138,.3)}
.sig-card.watch{border-color:rgba(255,200,90,.25)}
.gauge-wrap{position:relative;height:20px;border-radius:6px;overflow:hidden;margin:10px 0}
.gauge-bg{
  position:absolute;inset:0;
  background:linear-gradient(90deg,
    #ff4d6d 0%,#ff4d6d 20%,
    #ffc85a 20%,#ffc85a 30%,
    #7ee8a2 30%,#7ee8a2 55%,
    #ffc85a 55%,#ffc85a 70%,
    #ff4d6d 70%,#ff4d6d 75%,
    #660020 75%)
}
.gauge-ptr{
  position:absolute;top:-3px;width:3px;height:26px;
  background:#fff;border-radius:2px;transform:translateX(-50%);
  transition:left .5s ease;box-shadow:0 0 6px rgba(255,255,255,.6)
}
.gauge-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--t3);margin-top:3px}

/* REGIME DISPLAY */
.regime-box{
  padding:10px 14px;border-radius:8px;
  font-family:var(--mono);font-size:12px;border:1px solid var(--line);
  background:var(--bg3);transition:all .3s
}

/* ACTIONS ROW */
.ar{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}

/* FILTER BAR */
.fb{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center}
.fb select,.fb input{padding:7px 11px;font-size:11px;max-width:160px}

/* DIVIDER */
hr{border:none;border-top:1px solid var(--line);margin:18px 0}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--t2)}
.empty-i{font-size:40px;margin-bottom:12px}
.empty-t{font-size:14px}

/* OPEN POS CARD */
.opc{
  border:1px solid var(--line);border-radius:10px;padding:14px 16px;
  margin-bottom:10px;background:var(--bg3);transition:border-color .2s
}
.opc.warn{border-color:rgba(255,107,138,.4)}

/* PROGRESS */
.pbw{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-top:5px}
.pb{height:100%;border-radius:3px;background:var(--acc);transition:width .5s}

/* CALC BOX */
.calcrow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bg4)}
.calcrow:last-child{border:none}
.calcrow span:first-child{color:var(--t2);font-family:var(--mono);font-size:10px}
.calcrow span:last-child{font-family:var(--mono);font-size:11px;font-weight:700}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">–ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó –û–ë–õ–ê–ö–ê...</div>
</div>

<!-- SYNC BANNER -->
<div id="syncBanner">
  <span id="syncMsg">‚òÅ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
  <span style="cursor:pointer;opacity:.7" onclick="hideSyncBanner()">‚úï</span>
</div>

<header>
  <div class="logo">
    <div class="logo-mark">RSI</div>
    <div>
      <div class="logo-name">Swing Journal</div>
      <div class="logo-ver">PURE RSI SYSTEM ¬∑ CLOUD SYNC</div>
    </div>
  </div>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px">
      <div class="sync-dot" id="syncDot"></div>
      <span class="sync-label" id="syncLabel">–ù–ï–¢ –î–ê–ù–ù–´–•</span>
    </div>
    <span id="hdrRegime" style="font-family:var(--mono);font-size:10px;color:var(--t2);letter-spacing:.5px"></span>
    <span style="font-family:var(--mono);font-size:10px;color:var(--t2)" id="hdrDate"></span>
  </div>
</header>

<nav>
  <div class="ntab active" onclick="goTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
  <div class="ntab" onclick="goTab('instruments')">üìà –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
  <div class="ntab" onclick="goTab('trades')">üìã –°–¥–µ–ª–∫–∏</div>
  <div class="ntab" onclick="goTab('watchlist')">üëÅ –°–ø–∏—Å–æ–∫</div>
  <div class="ntab" onclick="goTab('quarterly')">üìÖ –ö–≤–∞—Ä—Ç–∞–ª</div>
  <div class="ntab" onclick="goTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</nav>

<main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab active" id="tab-dashboard">
  <div class="g4" id="statsGrid" style="margin-bottom:24px"></div>
  <div class="g2">
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div class="sh" style="margin-bottom:0">–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏</div>
        <button class="btn btn-g btn-s" onclick="refreshLivePrices()" id="liveBtn" style="font-family:var(--mono);font-size:10px">üì° –¶–ï–ù–´</button>
      </div>
      <div id="openPos"></div>
    </div>
    <div>
      <div class="sh">–†—ã–Ω–æ—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä SPY</div>
      <div class="card" style="padding:18px">
        <div class="fgrid" style="grid-template-columns:1fr 1fr;margin-bottom:14px">
          <div class="fg">
            <label>SPY RSI(14)</label>
            <input type="number" id="spyRsi" min="0" max="100" step="0.1" placeholder="52.0" oninput="updRegime()">
          </div>
          <div class="fg">
            <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
            <div class="regime-box" id="regimeBox">‚Äî</div>
          </div>
        </div>
        <div class="gauge-wrap">
          <div class="gauge-bg"></div>
          <div class="gauge-ptr" id="gaugePtr" style="left:50%"></div>
        </div>
        <div class="gauge-labels">
          <span>0</span><span>20</span><span>30</span><span>45</span><span>55</span><span>70</span><span>80</span><span>100</span>
        </div>
        <hr>
        <div style="font-family:var(--mono);font-size:9px;color:var(--t2);letter-spacing:1px;margin-bottom:6px">–†–ê–ó–ú–ï–† –õ–û–ù–ì / –®–û–†–¢</div>
        <div id="sizeGuide" style="font-size:22px;font-weight:800;letter-spacing:-1px">‚Äî / ‚Äî</div>
        <div id="tradeNote" style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-top:4px"></div>
        <div class="ar">
          <button class="btn btn-p btn-s" onclick="saveRegime()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
      </div>
    </div>
  </div>
  <div style="margin-top:28px">
    <div class="sh">üéØ –°–∏–≥–Ω–∞–ª—ã –¥–Ω—è <span style="font-family:var(--mono);font-size:9px;color:var(--t2);font-weight:400" id="signalsDate"></span></div>
    <div id="signalsSection">
      <div class="empty" style="padding:24px"><div class="empty-t" style="font-family:var(--mono);font-size:11px">–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ RSI –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–°–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è¬ª</div></div>
    </div>
  </div>

  <div style="margin-top:28px">
    <div class="sh">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 8 —Å–¥–µ–ª–æ–∫</div>
    <div class="tw">
      <table><thead><tr>
        <th>–î–∞—Ç–∞</th><th>–¢–∏–∫–µ—Ä</th><th>–¢–∏–ø</th><th>–í—Ö–æ–¥</th><th>–í—ã—Ö–æ–¥</th><th>P&L%</th><th>T</th><th>–°—Ç–∞—Ç—É—Å</th>
      </tr></thead>
      <tbody id="recentTb"><tr><td colspan="8" style="text-align:center;color:var(--t2);padding:36px">–°–¥–µ–ª–æ–∫ –Ω–µ—Ç</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INSTRUMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab" id="tab-instruments">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:12px">
    <div>
      <div style="font-size:22px;font-weight:800">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--t2);margin-top:3px">–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Ç–∏–∫–µ—Ä–∞–º –∏–∑ —Å–¥–µ–ª–æ–∫</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <select id="instrSort" onchange="renderInstruments()" style="font-size:12px">
        <option value="trades">–ü–æ –∫–æ–ª-–≤—É —Å–¥–µ–ª–æ–∫</option>
        <option value="pnl">–ü–æ P&L</option>
        <option value="ticker">–ü–æ —Ç–∏–∫–µ—Ä—É</option>
        <option value="lastTrade">–ü–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–µ</option>
      </select>
    </div>
  </div>
  <div class="tw">
    <table>
      <thead>
        <tr>
          <th>–¢–∏–∫–µ—Ä</th>
          <th>–°–¥–µ–ª–æ–∫</th>
          <th>W/L</th>
          <th>–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã—Ö–æ–¥</th>
          <th>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ (–º–∏–Ω/–º–∞–∫—Å)</th>
          <th>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞ (–º–∏–Ω/–º–∞–∫—Å)</th>
          <th>–í–∞–ª–æ–≤—ã–π P&L</th>
        </tr>
      </thead>
      <tbody id="instrTb"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRADES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab" id="tab-trades">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:12px">
    <div style="font-size:22px;font-weight:800">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫</div>
    <button class="btn btn-p" onclick="openTrade()">+ –ù–û–í–ê–Ø –°–î–ï–õ–ö–ê</button>
  </div>
  <div class="fb">
    <select id="fType" onchange="renderTrades()"><option value="">–í—Å–µ —Ç–∏–ø—ã</option><option>LONG</option><option>SHORT</option></select>
    <select id="fStatus" onchange="renderTrades()"><option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option><option value="OPEN">–û—Ç–∫—Ä—ã—Ç—ã–µ</option><option value="PARTIAL">–ß–∞—Å—Ç–∏—á–Ω. –≤—ã—Ö–æ–¥</option><option value="CLOSED">–ó–∞–∫—Ä—ã—Ç—ã–µ</option></select>
    <select id="fResult" onchange="renderTrades()"><option value="">–†–µ–∑—É–ª—å—Ç–∞—Ç</option><option value="WIN">–í—ã–∏–≥—Ä—ã—à</option><option value="LOSS">–£–±—ã—Ç–æ–∫</option></select>
    <input id="fTicker" placeholder="–¢–∏–∫–µ—Ä..." oninput="renderTrades()" style="max-width:120px">
  </div>
  <div class="tw">
    <table><thead><tr>
      <th>–î–∞—Ç–∞</th><th>–¢–∏–∫–µ—Ä</th><th>–¢–∏–ø</th><th>–í—Ö–æ–¥ $</th><th>–°—Ç–æ–ø $</th>
      <th>–¶1 $</th><th>–¶2 $</th><th>RSI7</th><th>RSI14</th><th>SPY</th>
      <th>T</th><th>P&L%</th><th>–°—Ç–∞—Ç—É—Å</th><th></th>
    </tr></thead>
    <tbody id="tradesTb"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WATCHLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab" id="tab-watchlist">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:12px">
    <div>
      <div style="font-size:22px;font-weight:800">–°–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-top:3px">–¶–µ–ª—å: 40‚Äì50 –∞–∫—Ü–∏–π</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-g btn-s" onclick="saveRsiScan()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ RSI</button>
      <button class="btn btn-p" onclick="openWL()">+ –î–û–ë–ê–í–ò–¢–¨</button>
    </div>
  </div>

  <div class="g4" style="max-width:600px;margin-bottom:22px">
    <div class="stat" style="--sc:var(--acc)"><div class="stat-l">–í—Å–µ–≥–æ</div><div class="stat-v" id="wlTot">0</div></div>
    <div class="stat" style="--sc:var(--acc4)"><div class="stat-l">–û—Ç–∫—Ä—ã—Ç–∞ –ø–æ–∑.</div><div class="stat-v bl" id="wlOp">0</div></div>
    <div class="stat" style="--sc:var(--acc2)"><div class="stat-l">–ë–ª—ç–∫–∞—É—Ç</div><div class="stat-v r" id="wlBo">0</div></div>
    <div class="stat" style="--sc:var(--acc3)"><div class="stat-l">–û–∂–∏–¥–∞–Ω–∏–µ</div><div class="stat-v y" id="wlCd">0</div></div>
    <div class="stat" style="--sc:var(--acc)"><div class="stat-l">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div><div class="stat-v g" id="wlAct">0</div></div>
  </div>

  <!-- RSI SCAN TABLE -->
  <div style="margin-bottom:24px">
    <div class="sh">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ RSI
      <span style="font-family:var(--mono);font-size:9px;color:var(--t2);font-weight:400" id="scanDateLabel"></span>
    </div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-bottom:12px;padding:10px 14px;background:var(--bg3);border-radius:8px;border:1px solid var(--line)">
      –ó–∞–ø–æ–ª–Ω–∏—Ç–µ RSI(7) –∏ RSI(14) ‚Üí –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å RSI¬ª ‚Üí —Å–∏–≥–Ω–∞–ª—ã –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –î–∞—à–±–æ—Ä–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    </div>
    <div class="tw">
      <table>
        <thead><tr>
          <th>–¢–∏–∫–µ—Ä</th>
          <th>–°–µ–∫—Ç–æ—Ä</th>
          <th>RSI(7) —Å–µ–≥–æ–¥–Ω—è</th>
          <th>RSI(14) —Å–µ–≥–æ–¥–Ω—è</th>
          <th>–ò—Å—Ç–æ—Ä–∏—è RSI(7) ‚Üê 5 –¥–Ω–µ–π</th>
          <th>–°–∏–≥–Ω–∞–ª</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr></thead>
        <tbody id="rsiScanTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- WATCHLIST CARDS -->
  <div class="fb">
    <input id="wlSrch" placeholder="–ü–æ–∏—Å–∫..." oninput="renderWL()" style="max-width:180px">
    <select id="wlSect" onchange="renderWL()">
      <option value="">–í—Å–µ —Å–µ–∫—Ç–æ—Ä—ã</option>
      <option>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option><option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</option>
      <option>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π</option><option>–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option><option>–î—Ä—É–≥–æ–µ</option>
    </select>
    <select id="wlStat" onchange="renderWL()">
      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="position">–û—Ç–∫—Ä—ã—Ç–∞ –ø–æ–∑–∏—Ü–∏—è</option>
      <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
      <option value="blackout">–ë–ª—ç–∫–∞—É—Ç</option>
      <option value="cooldown">–û–∂–∏–¥–∞–Ω–∏–µ</option>
    </select>
  </div>
  <div class="wgrid" id="wlGrid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUARTERLY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab" id="tab-quarterly">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:12px">
    <div>
      <div style="font-size:22px;font-weight:800">–ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä</div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-top:3px" id="qLabel"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-g btn-s" onclick="qOff--; renderQ()">‚Üê –ü–†–ï–î</button>
      <button class="btn btn-g btn-s" onclick="qOff++; renderQ()">–°–õ–ï–î ‚Üí</button>
      <button class="btn btn-p btn-s" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
  <div class="g2">
    <div>
      <div class="card">
        <div class="sh">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
        <div class="fgrid">
          <div class="fg"><label>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</label><input type="number" id="q_t"></div>
          <div class="fg"><label>% –≤—ã–∏–≥—Ä—ã—à–µ–π</label><input type="number" id="q_wr" min="0" max="100" step=".1"></div>
          <div class="fg"><label>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å %</label><input type="number" id="q_r" step=".1"></div>
          <div class="fg"><label>–ú–∞–∫—Å –ø—Ä–æ—Å–∞–¥–∫–∞ %</label><input type="number" id="q_d" step=".1"></div>
          <div class="fg"><label>–°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à %</label><input type="number" id="q_aw" step=".1"></div>
          <div class="fg"><label>–°—Ä–µ–¥–Ω–∏–π —É–±—ã—Ç–æ–∫ %</label><input type="number" id="q_al" step=".1"></div>
        </div>
      </div>
      <div class="card">
        <div class="sh">–ü–µ—Ä–µ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞</div>
        <div class="cl" id="q-cl"></div>
        <div class="fgrid" style="margin-top:14px">
          <div class="fg"><label>–£–¥–∞–ª—ë–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏</label><input type="text" id="q_rem" placeholder="RIVN, NIO..."></div>
          <div class="fg"><label>–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏</label><input type="text" id="q_add" placeholder="SOFI, AFRM..."></div>
        </div>
        <div class="fg" style="margin-top:14px">
          <label>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏</label>
          <select id="q_ps">
            <option value="100">100% ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
            <option value="50">50% ‚Äî –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π</option>
            <option value="10">10% ‚Äî —Å–±—Ä–æ—Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</option>
          </select>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="sh">–ê–Ω–∞–ª–∏–∑ –∫–≤–∞—Ä—Ç–∞–ª–∞</div>
        <div class="fg" style="margin-bottom:12px"><label>–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ</label><textarea id="q_gd" placeholder="..."></textarea></div>
        <div class="fg" style="margin-bottom:12px"><label>–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å</label><textarea id="q_im" placeholder="..."></textarea></div>
        <div class="fg" style="margin-bottom:12px"><label>–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª</label><textarea id="q_vl" placeholder="..."></textarea></div>
        <div class="fg"><label>–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª</label><textarea id="q_ch" placeholder="..."></textarea></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab" id="tab-settings">
  <div style="font-size:22px;font-weight:800;margin-bottom:22px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  <div class="g2">
    <div>
      <div class="card">
        <div class="sh">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ä—Ç—Ñ–µ–ª—è</div>
        <div class="fgrid">
          <div class="fg"><label>–ü–æ—Ä—Ç—Ñ–µ–ª—å ($)</label><input type="number" id="s_pf" placeholder="100000"></div>
          <div class="fg"><label>–†–∏—Å–∫/—Å–¥–µ–ª–∫–∞ (%)</label><input type="number" id="s_rp" placeholder="1.5" step=".1"></div>
          <div class="fg"><label>–ú–∞–∫—Å –ø–æ–∑–∏—Ü–∏–π</label><input type="number" id="s_mp" placeholder="6"></div>
          <div class="fg"><label>–ú–∞–∫—Å –ø–æ–∑–∏—Ü–∏—è (%)</label><input type="number" id="s_mpp" placeholder="20"></div>
          <div class="fg"><label>–°—Ç–æ–ø (%)</label><input type="number" id="s_sp" placeholder="4" step=".5"></div>
          <div class="fg"><label>–¶–µ–ª—å 1 (%)</label><input type="number" id="s_t1" placeholder="4" step=".5"></div>
          <div class="fg"><label>–¶–µ–ª—å 2 (%)</label><input type="number" id="s_t2" placeholder="8" step=".5"></div>
          <div class="fg"><label>–ú–∞–∫—Å –¥–Ω–µ–π</label><input type="number" id="s_md" placeholder="5"></div>
        </div>
        <div class="ar">
          <button class="btn btn-p btn-s" onclick="saveSets()">–°–û–•–†–ê–ù–ò–¢–¨</button>
          <button class="btn btn-g btn-s" onclick="defSets()">–ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ</button>
        </div>
      </div>

      <div class="card">
        <div class="sh">Finnhub API ‚Äî –∂–∏–≤—ã–µ —Ü–µ–Ω—ã</div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-bottom:12px;line-height:1.7">
          –ü–æ–ª—É—á–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –∏ RSI –ø—Ä—è–º–æ –≤ –∂—É—Ä–Ω–∞–ª–µ.<br>
          –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ <b style="color:var(--text)">finnhub.io</b> ‚Üí Dashboard ‚Üí API Key
        </div>
        <div class="fg" style="margin-bottom:12px">
          <label>API –ö–ª—é—á</label>
          <div style="display:flex;gap:8px">
            <input type="text" id="s_fhkey" placeholder="–≤–∞—à –∫–ª—é—á..." style="flex:1;font-family:var(--mono);font-size:11px" oninput="saveFinnhubKey()">
            <button class="btn btn-g btn-s" onclick="testFinnhub()">–ü–†–û–í–ï–†–ò–¢–¨</button>
          </div>
        </div>
        <div id="fhStatus" style="font-family:var(--mono);font-size:10px;color:var(--t2);min-height:18px"></div>
      </div>

      <div class="card">
        <div class="sh">üêô GitHub ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-bottom:14px;line-height:1.8">
          –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ <b style="color:var(--acc)">rsi-watchlist</b> ¬∑ —Ñ–∞–π–ª <b style="color:var(--acc)">data.json</b><br>
          –¢–æ–∫–µ–Ω –≤–≤–æ–¥–∏—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
        </div>
        <div class="fg" style="margin-bottom:10px">
          <label>GitHub Token (ghp_...)</label>
          <div style="display:flex;gap:8px">
            <input type="password" id="s_gh_token" placeholder="ghp_xxxxxxxxxxxx" style="flex:1;font-family:var(--mono);font-size:11px" autocomplete="off">
            <button class="btn btn-p btn-s" onclick="saveGhToken()">–°–û–•–†–ê–ù–ò–¢–¨</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <button class="btn btn-g btn-s" onclick="testGithub()">‚úì –ü–†–û–í–ï–†–ò–¢–¨</button>
          <button class="btn btn-sync btn-s" onclick="syncFromGithub()">üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨</button>
        </div>
        <div id="ghStatus" style="font-family:var(--mono);font-size:10px;color:var(--t2);min-height:18px;margin-bottom:10px"></div>
        <div id="storageInfo" style="padding:10px 14px;background:var(--bg3);border-radius:8px;font-family:var(--mono);font-size:11px;border:1px solid var(--line)">
          –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
          <div class="sync-dot" id="syncDot2"></div>
          <span style="font-family:var(--mono);font-size:11px;color:var(--t2)" id="syncStatus2">‚Äî</span>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="sh">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–∏</div>
        <div class="fgrid" style="margin-bottom:14px">
          <div class="fg"><label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ ($)</label><input type="number" id="c_e" placeholder="0" oninput="calcPos()"></div>
          <div class="fg"><label>–°—Ç–æ–ø (%)</label><input type="number" id="c_s" placeholder="4" oninput="calcPos()"></div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:14px">
          <div class="calcrow"><span>–†–∏—Å–∫ ($)</span><span id="c_rd" class="y">‚Äî</span></div>
          <div class="calcrow"><span>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ ($)</span><span id="c_ps" class="g">‚Äî</span></div>
          <div class="calcrow"><span>–ö–æ–ª-–≤–æ –∞–∫—Ü–∏–π</span><span id="c_sh" class="g">‚Äî</span></div>
          <div class="calcrow"><span>–°—Ç–æ–ø-—Ü–µ–Ω–∞ ($)</span><span id="c_sp" class="r">‚Äî</span></div>
          <div class="calcrow"><span>–¶–µ–ª—å 1 ($)</span><span id="c_t1" class="g">‚Äî</span></div>
          <div class="calcrow"><span>–¶–µ–ª—å 2 ($)</span><span id="c_t2" class="g">‚Äî</span></div>
        </div>
      </div>

      <div class="card">
        <div class="sh">üìÖ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ NYSE/NASDAQ</div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--t2);margin-bottom:12px;line-height:1.7">
          –†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç –≤ —ç—Ç–∏ –¥–Ω–∏. –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π.
        </div>
        <div id="holidayWarning" style="display:none;padding:10px 14px;background:rgba(255,200,90,.1);border:1px solid var(--acc3);border-radius:8px;margin-bottom:12px;font-family:var(--mono);font-size:11px;color:var(--acc3)"></div>
        <div id="holidaysList" style="max-height:200px;overflow-y:auto;background:var(--bg3);border-radius:8px;padding:10px;margin-bottom:12px"></div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <div class="fg" style="flex:1;margin:0">
            <label>–î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</label>
            <input type="date" id="newHolidayDate">
          </div>
          <button class="btn btn-p btn-s" onclick="addHoliday()">+ –î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-g btn-s" onclick="resetHolidays()">‚Ü∫ –°–ë–†–û–°–ò–¢–¨ –ö –°–¢–ê–ù–î–ê–†–¢–ù–´–ú</button>
        </div>
      </div>

      <div class="card">
        <div class="sh">–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-g" onclick="exportJSON()">üì• –≠–ö–°–ü–û–†–¢ JSON</button>
          <label class="btn btn-g" style="cursor:pointer;justify-content:center">
            üì§ –ò–ú–ü–û–†–¢ JSON
            <input type="file" accept=".json" onchange="importJSON(event)" style="display:none">
          </label>
          <button class="btn btn-d" onclick="clearCloud()">üóë –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï</button>
        </div>
        <div style="margin-top:14px;padding:12px;background:var(--bg3);border-radius:8px;font-family:var(--mono);font-size:10px;color:var(--t3);line-height:1.7">
          –≠–∫—Å–ø–æ—Ä—Ç —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π JSON-—Ñ–∞–π–ª.<br>
          –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø.
        </div>
      </div>
    </div>
  </div>
</div>

</main>

<!-- TRADE MODAL -->
<div class="mo" id="moTrade">
  <div class="md">
    <div class="mh"><span id="moTradeTitle">–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞</span><span class="mclose" onclick="closeMo('moTrade')">‚úï</span></div>
    <input type="hidden" id="te_id">

    <!-- ROW 1: ticker / type / date -->
    <div class="fgrid" style="margin-bottom:0">
      <div class="fg">
        <label>–¢–∏–∫–µ—Ä</label>
        <div style="display:flex;gap:6px">
          <input type="text" id="te_tk" placeholder="NVDA" style="text-transform:uppercase;flex:1" oninput="this.value=this.value.toUpperCase()">
          <button class="btn btn-g btn-s" onclick="fetchTickerData()" title="–ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –∏ RSI" style="flex-shrink:0;white-space:nowrap" id="fetchBtn">üì° –¶–ï–ù–ê</button>
        </div>
      </div>
      <div class="fg"><label>–¢–∏–ø</label><select id="te_tp" onchange="tradeAutoCalc()"><option>LONG</option><option>SHORT</option></select></div>
      <div class="fg"><label>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞</label><input type="date" id="te_dt"></div>
    </div>
    <div id="fetchStatus" style="font-family:var(--mono);font-size:9px;color:var(--t2);margin-top:6px;display:none"></div>

    <hr style="margin:14px 0">

    <!-- ROW 2: entry + auto-calculated fields -->
    <div style="font-family:var(--mono);font-size:9px;color:var(--acc);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px">
      üí° –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ ‚Äî —Å—Ç–æ–ø –∏ —Ü–µ–ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    </div>
    <div class="fgrid">
      <div class="fg">
        <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ ($)</label>
        <input type="number" id="te_en" step=".01" placeholder="0.00" oninput="tradeAutoCalc()">
      </div>
      <div class="fg">
        <label>–ö–æ–ª-–≤–æ –∞–∫—Ü–∏–π</label>
        <input type="number" id="te_sh" placeholder="0">
      </div>
      <div class="fg">
        <label>–°—Ç–æ–ø ($) <span style="color:var(--t3);font-size:9px">–∞–≤—Ç–æ ‚àí4%</span></label>
        <input type="number" id="te_st" step=".01" placeholder="–∞–≤—Ç–æ" oninput="tradeMarkManual('st')">
      </div>
      <div class="fg">
        <label>–¶–µ–ª—å 1 ($) <span style="color:var(--t3);font-size:9px">–∞–≤—Ç–æ +4%</span></label>
        <input type="number" id="te_t1" step=".01" placeholder="–∞–≤—Ç–æ" oninput="tradeMarkManual('t1')">
      </div>
      <div class="fg">
        <label>–¶–µ–ª—å 2 ($) <span style="color:var(--t3);font-size:9px">–∞–≤—Ç–æ +8%</span></label>
        <input type="number" id="te_t2" step=".01" placeholder="–∞–≤—Ç–æ" oninput="tradeMarkManual('t2')">
      </div>
    </div>

    <!-- AUTO CALC PREVIEW -->
    <div id="te_calc_preview" style="display:none;background:var(--bg3);border:1px solid var(--line);border-radius:8px;padding:12px;margin:10px 0;font-family:var(--mono);font-size:10px">
      <div style="display:flex;flex-wrap:wrap;gap:14px" id="te_calc_rows"></div>
      <div id="te_calc_basis" style="margin-top:10px;padding-top:8px;border-top:1px solid var(--bg4);font-size:9px;color:var(--t3);line-height:1.6"></div>
    </div>

    <hr style="margin:14px 0">

    <!-- ROW 3: RSI + status -->
    <div class="fgrid">
      <div class="fg"><label>RSI(7)</label><input type="number" id="te_r7" step=".1" placeholder="18.5"></div>
      <div class="fg"><label>RSI(14)</label><input type="number" id="te_r14" step=".1" placeholder="32.0"></div>
      <div class="fg"><label>SPY RSI(14)</label><input type="number" id="te_spy" step=".1" placeholder="52.0"></div>
      <div class="fg"><label>–°—Ç–∞—Ç—É—Å</label><select id="te_sta" onchange="toggleExitFields()"><option value="OPEN">–û—Ç–∫—Ä—ã—Ç–∞</option><option value="PARTIAL">–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤—ã—Ö–æ–¥</option><option value="CLOSED">–ó–∞–∫—Ä—ã—Ç–∞</option></select></div>
    </div>

    <!-- PARTIAL EXIT FIELDS (shown only when PARTIAL) -->
    <div id="te_partial_section" style="display:none">
      <hr style="margin:14px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-family:var(--mono);font-size:10px;color:var(--acc);letter-spacing:1.5px;text-transform:uppercase">üéØ –ß–ê–°–¢–ò–ß–ù–´–ô –í–´–•–û–î (TARGET 1)</div>
      </div>
      <div style="background:rgba(126,232,162,.08);border:1px solid var(--acc);border-radius:8px;padding:12px;margin-bottom:14px">
        <div style="font-family:var(--mono);font-size:11px;color:var(--acc);line-height:1.7">
          ‚ö†Ô∏è <b>–í–ê–ñ–ù–û:</b> –ü–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø–µ—Ä–µ—Å—Ç–∞–≤—å—Ç–µ —Å—Ç–æ–ø –Ω–∞ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ (breakeven)!
        </div>
      </div>
      <div class="fgrid">
        <div class="fg">
          <label>–î–∞—Ç–∞ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞</label>
          <input type="date" id="te_p_date">
        </div>
        <div class="fg">
          <label>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞ ($)</label>
          <input type="number" id="te_p_price" step=".01" placeholder="0.00" oninput="calcPartialPnl()">
        </div>
        <div class="fg">
          <label>–ó–∞–∫—Ä—ã—Ç–æ –∞–∫—Ü–∏–π (50%)</label>
          <input type="number" id="te_p_shares" placeholder="0" oninput="calcPartialPnl()">
        </div>
        <div class="fg">
          <label>–ö–æ–º–∏—Å—Å–∏—è ($)</label>
          <input type="number" id="te_p_comm" step=".01" placeholder="0.00" oninput="calcPartialPnl()">
        </div>
      </div>
      <div id="partial_pnl_preview" style="display:none;background:var(--bg3);border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:10px">
        <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center">
          <div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">P&L —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ</div>
            <div id="partial_pnl_value" style="font-family:var(--mono);font-size:16px;font-weight:700">‚Äî</div>
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">–û—Å—Ç–∞—Ç–æ–∫ –∞–∫—Ü–∏–π</div>
            <div id="partial_remaining" style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--text)">‚Äî</div>
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">–ù–æ–≤—ã–π —Å—Ç–æ–ø</div>
            <div id="partial_new_stop" style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--acc3)">‚Üí BREAKEVEN</div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="te_p_be" style="width:16px;height:16px;accent-color:var(--acc)">
          <span style="font-family:var(--mono);font-size:11px;color:var(--text)">‚úì –°—Ç–æ–ø –ø–µ—Ä–µ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ breakeven</span>
        </label>
      </div>
    </div>

    <!-- EXIT FIELDS (shown only when CLOSED) -->
    <div id="te_exit_section" style="display:none">
      <hr style="margin:14px 0">
      <div style="font-family:var(--mono);font-size:10px;color:var(--acc2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px">–î–ê–ù–ù–´–ï –í–´–•–û–î–ê</div>
      <div class="fgrid">
        <div class="fg"><label>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞ ($)</label><input type="number" id="te_ex" step=".01" placeholder="0.00" oninput="tradeAutoCalc()"></div>
        <div class="fg"><label>–ö–æ–º–∏—Å—Å–∏–∏ ($) <span style="color:var(--t3);font-size:9px">–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥</span></label><input type="number" id="te_comm" step=".01" placeholder="0.00" oninput="tradeAutoCalc()"></div>
        <div class="fg"><label>–ü—Ä–∏—á–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞</label>
          <select id="te_er">
            <option value="">‚Äî</option>
            <option value="TARGET1">–¶–µ–ª—å 1 (+4%)</option>
            <option value="TARGET2">–¶–µ–ª—å 2 (+8%)</option>
            <option value="STOP">–°—Ç–æ–ø-–ª–æ—Å—Å (‚àí4%)</option>
            <option value="BREAKEVEN">Breakeven (–ø–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω.)</option>
            <option value="TIME">–î–µ–Ω—å 5 (–≤—Ä–µ–º—è)</option>
            <option value="RSI">RSI —Å–∏–≥–Ω–∞–ª</option>
            <option value="REGIME">–°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞</option>
          </select>
        </div>
        <div class="fg" id="pnl_preview_fg" style="display:none">
          <label>P&L</label>
          <div id="pnl_preview" style="padding:9px 13px;border-radius:8px;font-family:var(--mono);font-size:14px;font-weight:800;background:var(--bg3);border:1px solid var(--line)">‚Äî</div>
        </div>
      </div>
      <!-- Show partial exit summary if exists -->
      <div id="te_partial_summary" style="display:none;background:rgba(126,232,162,.05);border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:12px">
        <div style="font-family:var(--mono);font-size:9px;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">–†–ê–ù–ï–ï: –ß–ê–°–¢–ò–ß–ù–´–ô –í–´–•–û–î</div>
        <div id="te_partial_summary_content" style="font-family:var(--mono);font-size:11px;color:var(--t2)"></div>
      </div>
    </div>

    <div class="fg" style="margin-top:10px"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="te_nt" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–±–ª—é–¥–µ–Ω–∏—è..."></textarea></div>

    <div class="ar">
      <button class="btn btn-p" onclick="saveTrade()">–°–û–•–†–ê–ù–ò–¢–¨</button>
      <button class="btn btn-g" onclick="closeMo('moTrade')">–û–¢–ú–ï–ù–ê</button>
    </div>
  </div>
</div>

<!-- WATCHLIST MODAL -->
<div class="mo" id="moWL">
  <div class="md" style="max-width:460px">
    <div class="mh"><span id="moWLTitle">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ü–∏—é</span><span class="mclose" onclick="closeMo('moWL')">‚úï</span></div>
    <input type="hidden" id="wl_orig_ticker">
    <div class="fgrid">
      <div class="fg"><label>–¢–∏–∫–µ—Ä</label><input type="text" id="wl_tk" placeholder="TSLA" style="text-transform:uppercase"></div>
      <div class="fg"><label>–°–µ–∫—Ç–æ—Ä</label>
        <select id="wl_se">
          <option>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option><option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</option>
          <option>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π</option><option>–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option><option>–î—Ä—É–≥–æ–µ</option>
        </select>
      </div>
      <div class="fg"><label>–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–º–ª—Ä–¥ $)</label><input type="number" id="wl_cap" placeholder="50"></div>
      <div class="fg"><label>–ë–µ—Ç–∞</label><input type="number" id="wl_bt" placeholder="1.4" step=".1"></div>
      <div class="fg"><label>–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞ (earnings)</label><input type="date" id="wl_bo"></div>
      <div class="fg"><label>–ö—É–ª–¥–∞—É–Ω –¥–æ (–ø–æ—Å–ª–µ —Å—Ç–æ–ø–∞)</label><input type="date" id="wl_cd"></div>
      <div class="fg full"><label>–ó–∞–º–µ—Ç–∫–∏</label><input type="text" id="wl_nt" placeholder="–î–æ–ø. –∏–Ω—Ñ–æ..."></div>
    </div>
    <div class="ar">
      <button class="btn btn-p" id="wlSaveBtn" onclick="saveWL()">–î–û–ë–ê–í–ò–¢–¨</button>
      <button class="btn btn-g" onclick="closeMo('moWL')">–û–¢–ú–ï–ù–ê</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- HISTORICAL RSI MODAL -->
<div class="mo" id="moHistRsi">
  <div class="md" style="max-width:380px">
    <div class="mh">
      <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å RSI</span>
      <span class="mclose" onclick="closeMo('moHistRsi')">‚úï</span>
    </div>
    <div style="font-family:var(--mono);font-size:12px;color:var(--acc4);margin-bottom:14px">
      <span id="histRsiTicker" style="font-weight:700"></span> ¬∑ <span id="histRsiDate"></span>
    </div>
    <input type="hidden" id="histRsi_ticker">
    <input type="hidden" id="histRsi_date">
    <div class="fgrid">
      <div class="fg">
        <label>RSI(7)</label>
        <input type="number" id="histRsi_r7" min="0" max="100" step="0.1" placeholder="‚Äî">
      </div>
      <div class="fg">
        <label>RSI(14)</label>
        <input type="number" id="histRsi_r14" min="0" max="100" step="0.1" placeholder="‚Äî">
      </div>
    </div>
    <div class="ar" style="margin-top:14px">
      <button class="btn btn-p" onclick="saveHistRsi()">–°–û–•–†–ê–ù–ò–¢–¨</button>
      <button class="btn btn-d btn-s" onclick="clearHistRsi()">–û–ß–ò–°–¢–ò–¢–¨</button>
      <button class="btn btn-g" onclick="closeMo('moHistRsi')">–û–¢–ú–ï–ù–ê</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE ENGINE v6
// GitHub repo = primary sync | localStorage = instant cache
// Token stored ONLY in localStorage ‚Äî never in code
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GH_OWNER = 'mariiashumova1979-collab';
const GH_REPO  = 'rsi-watchlist';
const GH_FILE  = 'data.json';
const LS_KEY   = 'rsi_journal_v2';
const LS_TOKEN = 'gh_token_v1';

let ghFileSha   = null;
let storageMode = 'local';

// Default settings
const DEF_SETS = {
  portfolio: 100000, riskPct: 1.5, maxPosPct: 40,
  stopPct: 4, target1: 4, target2: 8, maxDays: 5
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// US MARKET HOLIDAYS 2025-2026 (NYSE/NASDAQ closed)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const US_HOLIDAYS_DEFAULT = [
  // 2025
  '2025-01-01', // New Year's Day
  '2025-01-20', // MLK Day
  '2025-02-17', // Presidents Day
  '2025-04-18', // Good Friday
  '2025-05-26', // Memorial Day
  '2025-06-19', // Juneteenth
  '2025-07-04', // Independence Day
  '2025-09-01', // Labor Day
  '2025-11-27', // Thanksgiving
  '2025-12-25', // Christmas
  // 2026
  '2026-01-01', // New Year's Day
  '2026-01-19', // MLK Day
  '2026-02-16', // Presidents Day
  '2026-04-03', // Good Friday
  '2026-05-25', // Memorial Day
  '2026-06-19', // Juneteenth
  '2026-07-03', // Independence Day (observed)
  '2026-09-07', // Labor Day
  '2026-11-26', // Thanksgiving
  '2026-12-25', // Christmas
];

// Early close days (13:00 EST) ‚Äî informational
const US_EARLY_CLOSE = [
  '2025-07-03', // Day before Independence Day
  '2025-11-28', // Day after Thanksgiving
  '2025-12-24', // Christmas Eve
  '2026-11-27', // Day after Thanksgiving
  '2026-12-24', // Christmas Eve
];

// Get holidays list (user custom + defaults)
function getHolidays() {
  const custom = cache.settings?.holidays || [];
  // Merge: custom overrides or adds to defaults
  const all = new Set([...US_HOLIDAYS_DEFAULT, ...custom]);
  // Remove any dates marked for deletion (prefixed with -)
  custom.filter(d => d.startsWith('-')).forEach(d => all.delete(d.slice(1)));
  return Array.from(all).sort();
}

function isHoliday(dateStr) {
  return getHolidays().includes(dateStr);
}

function isEarlyClose(dateStr) {
  return US_EARLY_CLOSE.includes(dateStr);
}

function isTradingDay(dateStr) {
  const d = new Date(dateStr);
  const dow = d.getDay();
  if (dow === 0 || dow === 6) return false; // weekend
  if (isHoliday(dateStr)) return false;
  return true;
}

// In-memory cache
const cache = { trades:[], watchlist:[], quarterly:{}, checklist:{}, settings:{}, regime:{}, rsiScans:{} };

let saveTimer = null;
function scheduleSave() { clearTimeout(saveTimer); saveTimer = setTimeout(doSave, 800); }

// Token: stored ONLY in localStorage, never in source code
function getToken() {
  try { 
    const raw = localStorage.getItem(LS_TOKEN) || '';
    // Clean token: remove any non-ASCII characters that could break fetch headers
    return raw.replace(/[^\x00-\x7F]/g, '').trim();
  } catch { return ''; }
}
function saveToken(t) {
  try { 
    // Clean token before saving
    const clean = (t || '').replace(/[^\x00-\x7F]/g, '').trim();
    localStorage.setItem(LS_TOKEN, clean); 
  } catch {}
}

function ghAPI()  { return `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_FILE}`; }
function ghRAW()  { return `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/main/${GH_FILE}`; }

// ‚îÄ‚îÄ WRITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSave() {
  const token = getToken();
  const payload = JSON.stringify(cache, null, 2);

  // Always write to localStorage immediately
  try { localStorage.setItem(LS_KEY, payload); } catch {}

  if (!token) {
    storageMode = 'local';
    setSyncState('synced', 'üíæ –õ–û–ö–ê–õ–¨–ù–û');
    updateStorageInfo();
    return;
  }

  setSyncState('syncing', '–°–û–•–†–ê–ù–ï–ù–ò–ï...');
  try {
    // Get SHA if we don't have it
    if (!ghFileSha) await fetchGhSha(token);

    const body = {
      message: 'journal ' + new Date().toISOString().slice(0,16),
      content: btoa(unescape(encodeURIComponent(payload))),
      branch: 'main'
    };
    if (ghFileSha) body.sha = ghFileSha;

    const res = await fetch(ghAPI(), {
      method: 'PUT',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'X-GitHub-Api-Version': '2022-11-28' },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      const d = await res.json();
      ghFileSha = d.content?.sha || ghFileSha;
      storageMode = 'github';
      setSyncState('synced', 'üêô GITHUB');
    } else if (res.status === 409 || res.status === 422) {
      await fetchGhSha(token);
      setTimeout(doSave, 1000);
      return;
    } else {
      throw new Error('HTTP ' + res.status);
    }
  } catch(e) {
    storageMode = 'local';
    setSyncState('synced', 'üíæ –õ–û–ö–ê–õ–¨–ù–û');
    console.warn('GitHub save:', e.message);
  }
  updateStorageInfo();
}

async function fetchGhSha(token) {
  try {
    const res = await fetch(ghAPI(), {
      headers: { 'Authorization': 'Bearer ' + (token || getToken()), 'X-GitHub-Api-Version': '2022-11-28' }
    });
    if (res.ok) { const d = await res.json(); ghFileSha = d.sha; }
  } catch {}
}

// ‚îÄ‚îÄ READ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromStorage() {
  const token = getToken();

  // 1. localStorage FIRST ‚Äî instant, no network needed
  let localData = null;
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) localData = JSON.parse(raw);
  } catch {}

  // If no token ‚Äî use localStorage only
  if (!token) {
    storageMode = 'local';
    return localData;
  }

  // 2. Try GitHub (with timeout so app never hangs)
  try {
    const controller = new AbortController();
    const tid = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(ghRAW() + '?t=' + Date.now(), { signal: controller.signal });
    clearTimeout(tid);

    if (res.ok) {
      const text = await res.text();
      const trimmed = text.trim();
      if (trimmed && trimmed !== '{}' && trimmed !== '') {
        const data = JSON.parse(trimmed);
        storageMode = 'github';
        try { localStorage.setItem(LS_KEY, trimmed); } catch {}
        fetchGhSha(token); // get SHA for writes, non-blocking
        return data;
      }
    }
  } catch(e) {
    if (e.name !== 'AbortError') console.warn('GitHub load:', e.message);
  }

  // 3. Fallback to local
  storageMode = localData ? 'local' : 'local';
  return localData;
}

async function probeStorage() { /* noop ‚Äî done in loadFromStorage */ }

function storageModeLabel() {
  return { github: 'üêô GITHUB', local: 'üíæ –õ–û–ö–ê–õ–¨–ù–û' }[storageMode] || storageMode;
}

// ‚îÄ‚îÄ GitHub settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveGhToken() {
  const t = (document.getElementById('s_gh_token')?.value || '').trim();
  if (t) { saveToken(t); toast('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì'); scheduleSave(); }
  else { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', true); }
}

function loadGhUI() {
  const el = document.getElementById('s_gh_token');
  const t = getToken();
  if (el) el.value = t ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + t.slice(-4) : '';
}

async function testGithub() {
  const el = document.getElementById('ghStatus');
  const token = getToken();
  if (!token) { el.textContent = '‚úó –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω'; el.style.color = 'var(--acc2)'; return; }
  el.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...'; el.style.color = 'var(--t2)';
  try {
    const res = await fetch(ghAPI(), {
      headers: { 'Authorization': 'Bearer ' + token, 'X-GitHub-Api-Version': '2022-11-28' }
    });
    if (res.ok) {
      const d = await res.json();
      ghFileSha = d.sha;
      el.textContent = '‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ ¬∑ ' + GH_OWNER + '/' + GH_REPO;
      el.style.color = 'var(--acc)';
      storageMode = 'github';
      updateStorageInfo();
    } else {
      el.textContent = '‚úó HTTP ' + res.status + ' ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω'; el.style.color = 'var(--acc2)';
    }
  } catch(e) { el.textContent = '‚úó ' + e.message; el.style.color = 'var(--acc2)'; }
}

async function syncFromGithub() {
  setSyncState('syncing', '–ó–ê–ì–†–£–ó–ö–ê...');
  try {
    const data = await loadFromStorage();
    if (data) { applyData(data); loadSetsUI(); loadGhUI(); loadFhKeyUI(); initChecklist(); renderDash(); renderTrades(); renderWL(); renderQ(); renderRsiScan(); const rsi = cache.regime?.spyRsi14; if (rsi) { document.getElementById('spyRsi').value = rsi; updRegime(false); } }
    setSyncState('synced', storageModeLabel());
    updateStorageInfo();
    toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì');
  } catch(e) { setSyncState('synced', '‚ö† –û–®–ò–ë–ö–ê'); toast('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

async function forceSync() { return syncFromGithub(); }

function applyData(data) {
  if (!data) return;
  if (Array.isArray(data.trades))    cache.trades    = data.trades;
  if (Array.isArray(data.watchlist)) cache.watchlist = data.watchlist;
  if (data.quarterly) cache.quarterly = data.quarterly;
  if (data.checklist) cache.checklist = data.checklist;
  if (data.settings)  { cache.settings = data.settings; if (!cache.settings.finnhubKey) cache.settings.finnhubKey = FINNHUB_KEY; }
  if (data.regime)    cache.regime    = data.regime;
  if (data.rsiScans)  cache.rsiScans  = data.rsiScans;
}

function updateStorageInfo() {
  const el = document.getElementById('storageInfo');
  if (!el) return;
  const gh = storageMode === 'github';
  const hasToken = !!getToken();
  el.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--bg4)">
      <span style="color:${gh?'var(--acc)':hasToken?'var(--acc3)':'var(--t3)'}">üêô</span>
      <span style="font-size:11px;color:${gh?'var(--acc)':'var(--t2)'}">GitHub ¬∑ ${GH_OWNER}/${GH_REPO}</span>
      ${gh?'<span style="background:var(--acc);color:var(--bg);font-size:8px;padding:1px 5px;border-radius:8px;font-weight:700;margin-left:auto">–ê–ö–¢–ò–í–ù–û</span>':''}
    </div>
    <div style="display:flex;align-items:center;gap:8px;padding:5px 0">
      <span style="color:var(--acc3)">üíæ</span>
      <span style="font-size:11px;color:var(--t2)">localStorage</span>
      ${storageMode==='local'?'<span style="background:var(--acc3);color:var(--bg);font-size:8px;padding:1px 5px;border-radius:8px;font-weight:700;margin-left:auto">–ê–ö–¢–ò–í–ù–û</span>':'<span style="font-size:9px;color:var(--t3);margin-left:auto">–∫—ç—à</span>'}
    </div>
    <div style="margin-top:6px;font-size:9px;color:var(--t3)">–†–µ–∂–∏–º: <b style="color:var(--text)">${storageModeLabel()}</b>${ghFileSha?' ¬∑ SHA: '+ghFileSha.slice(0,7):''}</div>`;
}

function setSyncState(state, label) {
  ['syncDot','syncDot2'].forEach(id => { const el=document.getElementById(id); if(el) el.className='sync-dot '+state; });
  const sl=document.getElementById('syncLabel'); if(sl) sl.textContent=label;
  const s2=document.getElementById('syncStatus2'); if(s2) s2.textContent=label;
}

// Legacy aliases
async function persistToCloud() { return doSave(); }
async function saveCloud()      { scheduleSave(); return true; }
async function cloudDel() {
  try { localStorage.removeItem(LS_KEY); } catch {}
  const token = getToken();
  if (!token) return;
  try {
    if (!ghFileSha) await fetchGhSha(token);
    await fetch(ghAPI(), { method:'PUT', headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json','X-GitHub-Api-Version':'2022-11-28'}, body:JSON.stringify({message:'clear',content:btoa('{}'),sha:ghFileSha,branch:'main'}) });
  } catch {}
}

function getGhCreds() { return { token: getToken(), gistId: null }; }
function saveGhCreds() { saveGhToken(); }
function loadGhCredsFromStorage() {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTab(name) {
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[onclick="goTab('${name}')"]`).classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg, err=false) {
  clearTimeout(toastTimer);
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (err?' err':'');
  toastTimer = setTimeout(()=>el.className='', 2600);
}

// –ó–∞–º–µ–Ω—è–µ—Ç confirm() ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ iframe –≥–¥–µ confirm() –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
function confirmDialog(msg, onYes) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.innerHTML = `
    <div style="background:var(--bg2);border:1px solid var(--line);border-radius:14px;padding:24px 20px;max-width:340px;width:100%;text-align:center">
      <div style="font-size:13px;color:var(--text);margin-bottom:20px;line-height:1.5">${msg}</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button id="cdYes" style="background:var(--acc2);color:#fff;border:none;border-radius:8px;padding:10px 24px;font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer">–î–ê</button>
        <button id="cdNo"  style="background:var(--bg4);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:10px 24px;font-family:var(--mono);font-size:12px;cursor:pointer">–û–¢–ú–ï–ù–ê</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#cdYes').onclick = () => { overlay.remove(); onYes(); };
  overlay.querySelector('#cdNo').onclick  = () => overlay.remove();
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC BANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSyncBanner(msg, err=false) {
  const b = document.getElementById('syncBanner');
  document.getElementById('syncMsg').textContent = msg;
  b.className = err ? 'show error' : 'show';
  setTimeout(hideSyncBanner, 2500);
}
function hideSyncBanner() { document.getElementById('syncBanner').className=''; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REGIME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updRegime(flash=true) {
  const val = parseFloat(document.getElementById('spyRsi').value);
  const ptr = document.getElementById('gaugePtr');
  if (!isNaN(val)) ptr.style.left = Math.min(100,Math.max(0,val)) + '%';

  const box  = document.getElementById('regimeBox');
  const size = document.getElementById('sizeGuide');
  const note = document.getElementById('tradeNote');
  const hdr  = document.getElementById('hdrRegime');

  if (isNaN(val)) return;

  let regime, longS, shortS, noteT, color;

  if (val > 80 || val < 20) {
    regime='üö´ –¢–û–†–ì–û–í–õ–Ø –û–¢–ö–õ–Æ–ß–ï–ù–ê'; longS='‚Äî'; shortS='‚Äî';
    noteT='–¢–æ–ª—å–∫–æ –∫—ç—à ‚Äî –ø–∞–Ω–∏–∫–∞ –Ω–∞ —Ä—ã–Ω–∫–µ'; color='var(--acc2)';
  } else if (val > 75) {
    regime='‚ö†Ô∏è –≠–ö–°–¢–†–ï–ú. –ü–ï–†–ï–ö–£–ü–õ–ï–ù–ù–û–°–¢–¨'; longS='–ù–ï–¢'; shortS='100%';
    noteT='–¢–æ–ª—å–∫–æ —à–æ—Ä—Ç—ã'; color='var(--acc2)';
  } else if (val >= 55) {
    regime='üìà –ë–´–ß–ò–ô'; longS='50%'; shortS='100%';
    noteT='–õ–æ–Ω–≥–∏ 50% —Ä–∞–∑–º–µ—Ä–∞'; color='var(--acc3)';
  } else if (val >= 45) {
    regime='‚öñÔ∏è –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ô'; longS='100%'; shortS='100%';
    noteT='–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞'; color='var(--acc)';
  } else if (val >= 30) {
    regime='üìâ –ú–ï–î–í–ï–ñ–ò–ô'; longS='100%'; shortS='50%';
    noteT='–®–æ—Ä—Ç—ã 50% —Ä–∞–∑–º–µ—Ä–∞'; color='var(--acc3)';
  } else {
    regime='‚ö†Ô∏è –≠–ö–°–¢–†–ï–ú. –ü–ï–†–ï–ü–†–û–î–ê–ù–ù–û–°–¢–¨'; longS='100%'; shortS='–ù–ï–¢';
    noteT='–¢–æ–ª—å–∫–æ –ª–æ–Ω–≥–∏'; color='var(--acc)';
  }

  box.textContent = regime; box.style.color = color;
  size.innerHTML = `<span class="g">${longS}</span> <span style="color:var(--t2)"> / </span> <span class="r">${shortS}</span>`;
  note.textContent = noteT;
  hdr.textContent = regime.replace(/[^–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\.%]/g,'').trim();
}

async function saveRegime() {
  const val = parseFloat(document.getElementById('spyRsi').value);
  if (isNaN(val)) return;
  cache.regime = { spyRsi14: val, savedAt: new Date().toISOString() };
  scheduleSave(); const ok = true;
  if (ok) toast('–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSetsUI() {
  const s = cache.settings;
  Object.entries(s).forEach(([k,v]) => { const el=document.getElementById('s_'+k.replace('Pct','p').replace('portfolio','pf').replace('maxPos','mp').replace('maxPosPct','mpp').replace('stopPct','sp').replace('target','t').replace('maxDays','md')); });
  // direct mapping
  const map = {pf:'portfolio',rp:'riskPct',mp:'maxPos',mpp:'maxPosPct',sp:'stopPct',t1:'target1',t2:'target2',md:'maxDays'};
  Object.entries(map).forEach(([id,key]) => { const el=document.getElementById('s_'+id); if(el&&s[key]!==undefined) el.value=s[key]; });
}

async function saveSets() {
  const map = {pf:'portfolio',rp:'riskPct',mp:'maxPos',mpp:'maxPosPct',sp:'stopPct',t1:'target1',t2:'target2',md:'maxDays'};
  const s = {};
  Object.entries(map).forEach(([id,key]) => { const el=document.getElementById('s_'+id); if(el) s[key]=parseFloat(el.value)||0; });
  cache.settings = s;
  scheduleSave(); const ok = true;
  if(ok) toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úì');
}

function defSets() {
  confirmDialog('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?', () => {
    cache.settings = {...DEF_SETS};
    scheduleSave();
    loadSetsUI(); toast('–°–±—Ä–æ—à–µ–Ω–æ ‚úì');
  });
}

function getSets() { return {...DEF_SETS,...cache.settings}; }

function calcPos() {
  const s = getSets();
  const entry = parseFloat(document.getElementById('c_e').value);
  const stopP = parseFloat(document.getElementById('c_s').value) || s.stopPct;
  if (!entry || !s.portfolio) return;
  const riskD  = s.portfolio * (s.riskPct/100);
  const stopDist = entry * (stopP/100);
  let shares = Math.floor(riskD/stopDist);
  let pos = shares * entry;
  const maxP = s.portfolio * (s.maxPosPct/100);
  if(pos > maxP){ pos=maxP; shares=Math.floor(pos/entry); }
  document.getElementById('c_rd').textContent = '$'+(shares*stopDist).toFixed(2);
  document.getElementById('c_ps').textContent = '$'+(shares*entry).toFixed(2);
  document.getElementById('c_sh').textContent = shares;
  document.getElementById('c_sp').textContent = '$'+(entry-stopDist).toFixed(2);
  document.getElementById('c_t1').textContent = '$'+(entry*(1+s.target1/100)).toFixed(2);
  document.getElementById('c_t2').textContent = '$'+(entry*(1+s.target2/100)).toFixed(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOLIDAYS MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHolidays() {
  const holidays = getHolidays();
  const todayStr = today();
  const container = document.getElementById('holidaysList');
  if (!container) return;

  // Filter to show only current year and next year
  const currentYear = new Date().getFullYear();
  const relevantHolidays = holidays.filter(d => {
    const year = parseInt(d.slice(0, 4));
    return year >= currentYear && year <= currentYear + 1;
  });

  if (!relevantHolidays.length) {
    container.innerHTML = '<div style="color:var(--t3);font-size:11px;text-align:center;padding:10px">–ù–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤</div>';
    return;
  }

  container.innerHTML = relevantHolidays.map(d => {
    const isPast = d < todayStr;
    const isCustom = (cache.settings?.holidays || []).includes(d);
    const name = getHolidayName(d);
    const dateObj = new Date(d);
    const dayName = dateObj.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
    
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:6px;margin-bottom:4px;background:${isPast ? 'transparent' : 'rgba(255,200,90,.05)'};opacity:${isPast ? '0.5' : '1'}">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-family:var(--mono);font-size:11px;color:${isPast ? 'var(--t3)' : 'var(--acc3)'}">${d}</span>
        <span style="font-size:11px;color:var(--t2)">${dayName}</span>
        <span style="font-size:11px;color:var(--text)">${name}</span>
        ${isCustom ? '<span style="font-size:9px;color:var(--acc4);background:rgba(91,156,246,.15);padding:2px 6px;border-radius:10px">CUSTOM</span>' : ''}
      </div>
      ${isCustom ? `<button onclick="removeHoliday('${d}')" style="background:none;border:none;color:var(--acc2);cursor:pointer;font-size:14px;padding:2px 6px" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>` : ''}
    </div>`;
  }).join('');

  // Show warning if upcoming holiday
  checkHolidayWarning();
}

function checkHolidayWarning() {
  const warningEl = document.getElementById('holidayWarning');
  if (!warningEl) return;

  const todayStr = today();
  const holidays = getHolidays();
  
  // Check next 5 calendar days for holidays
  const warnings = [];
  for (let i = 1; i <= 5; i++) {
    const d = new Date();
    d.setDate(d.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    if (holidays.includes(dateStr)) {
      const name = getHolidayName(dateStr);
      const dayName = d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'short' });
      if (i === 1) {
        warnings.push(`‚ö†Ô∏è –ó–ê–í–¢–†–ê –ø—Ä–∞–∑–¥–Ω–∏–∫: ${name} (${dayName}) ‚Äî —Ä—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç`);
      } else {
        warnings.push(`üìÖ –ß–µ—Ä–µ–∑ ${i} –¥–Ω.: ${name} (${dayName})`);
      }
    }
  }

  // Check if today is early close
  if (isEarlyClose(todayStr)) {
    warnings.unshift('‚è∞ –°–ï–ì–û–î–ù–Ø —Ä–∞–Ω–Ω–∏–π close –≤ 13:00 EST');
  }

  if (warnings.length) {
    warningEl.style.display = '';
    warningEl.innerHTML = warnings.join('<br>');
  } else {
    warningEl.style.display = 'none';
  }
}

function addHoliday() {
  const input = document.getElementById('newHolidayDate');
  const dateStr = input?.value;
  if (!dateStr) {
    toast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!', true);
    return;
  }

  if (!cache.settings) cache.settings = {...DEF_SETS};
  if (!cache.settings.holidays) cache.settings.holidays = [];

  if (getHolidays().includes(dateStr)) {
    toast('–≠—Ç–∞ –¥–∞—Ç–∞ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ', true);
    return;
  }

  cache.settings.holidays.push(dateStr);
  scheduleSave();
  renderHolidays();
  input.value = '';
  toast(`–ü—Ä–∞–∑–¥–Ω–∏–∫ ${dateStr} –¥–æ–±–∞–≤–ª–µ–Ω ‚úì`);
}

function removeHoliday(dateStr) {
  if (!cache.settings?.holidays) return;
  
  // If it's a default holiday, mark for deletion with '-'
  if (US_HOLIDAYS_DEFAULT.includes(dateStr)) {
    if (!cache.settings.holidays.includes('-' + dateStr)) {
      cache.settings.holidays.push('-' + dateStr);
    }
  } else {
    // Remove custom holiday
    cache.settings.holidays = cache.settings.holidays.filter(d => d !== dateStr);
  }
  
  scheduleSave();
  renderHolidays();
  toast(`–ü—Ä–∞–∑–¥–Ω–∏–∫ ${dateStr} —É–¥–∞–ª—ë–Ω`);
}

function resetHolidays() {
  confirmDialog('–°–±—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?', () => {
    if (cache.settings) {
      cache.settings.holidays = [];
    }
    scheduleSave();
    renderHolidays();
    toast('–ü—Ä–∞–∑–¥–Ω–∏–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã ‚úì');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICE ENGINE ‚Äî Claude API —Å web_search (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ sandbox)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FINNHUB_KEY = 'd65uv7pr01qiish15ra0d65uv7pr01qiish15rag';

function getFhKey() {
  return cache.settings?.finnhubKey || FINNHUB_KEY;
}

function saveFinnhubKey() {
  const key = document.getElementById('s_fhkey')?.value?.trim() || '';
  if (!cache.settings) cache.settings = {...DEF_SETS};
  cache.settings.finnhubKey = key || FINNHUB_KEY;
  scheduleSave();
}

function loadFhKeyUI() {
  const el = document.getElementById('s_fhkey');
  if (el) el.value = getFhKey();
}

let livePrices = {};

// ‚îÄ‚îÄ –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Claude API (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –≤ sandbox) ‚îÄ
async function fetchPricesViaClaude(tickers) {
  const list = Array.isArray(tickers) ? tickers : [tickers];
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: 1024,
      tools: [{ type: 'web_search_20250305', name: 'web_search' }],
      messages: [{
        role: 'user',
        content: `Search for current stock prices for: ${list.join(', ')}.
For each ticker return: current price, today % change, RSI(7) and RSI(14).
Respond ONLY with a valid JSON array, no markdown, no explanation:
[{"ticker":"AAPL","price":189.50,"change":0.82,"rsi7":45.2,"rsi14":52.1}]`
      }]
    })
  });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const data = await resp.json();
  const text = (data.content || []).map(b => b.text || '').join('');
  const match = text.match(/\[[\s\S]*?\]/);
  if (!match) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
  return JSON.parse(match[0]);
}

function calcRSI(closes, period) {
  if (!closes || closes.length < period + 1) return null;
  const slice = closes.slice(-(period + 1));
  let gains = 0, losses = 0;
  for (let i = 1; i < slice.length; i++) {
    const diff = slice[i] - slice[i-1];
    if (diff > 0) gains += diff; else losses -= diff;
  }
  const avgGain = gains / period, avgLoss = losses / period;
  if (avgLoss === 0) return 100;
  return parseFloat((100 - 100 / (1 + avgGain / avgLoss)).toFixed(1));
}

function setManualPrice(ticker, val) {
  const price = parseFloat(val);
  if (!price) { delete livePrices[ticker]; return; }
  livePrices[ticker] = { price, manual: true };
  // Update P&L display in-place ‚Äî do NOT call renderDash() to avoid losing focus
  document.querySelectorAll(`[data-ticker-pnl="${ticker}"]`).forEach(el => {
    const entry  = parseFloat(el.dataset.entry)  || 0;
    const shares = parseInt(el.dataset.shares)   || 0;
    const dir    = el.dataset.dir === '-1' ? -1 : 1;
    if (!entry) return;
    const pnlPct = dir * (price - entry) / entry * 100;
    const pnlAmt = shares ? pnlPct / 100 * entry * shares : null;
    const col    = pnlPct >= 0 ? 'var(--acc)' : 'var(--acc2)';
    el.innerHTML = `<span style="font-size:13px;font-weight:800;color:${col}">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%</span>`
      + (pnlAmt !== null ? ` <span style="font-size:10px;color:var(--t2)">($${Math.abs(pnlAmt).toFixed(0)})</span>` : '');
  });
}

function manualPriceInput(t) {
  const lp = livePrices[t.ticker];
  const cur = lp?.price || '';
  return `<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--bg3);border-radius:6px;border:1px solid var(--line);flex-wrap:wrap">
    <span style="font-family:var(--mono);font-size:9px;color:var(--t2)">–¢–µ–∫. —Ü–µ–Ω–∞ $</span>
    <input type="number" step=".01" placeholder="${t.entry||'0.00'}" value="${cur}"
      style="width:90px;font-family:var(--mono);font-size:13px;font-weight:700;padding:3px 8px;background:var(--bg4);border:1px solid var(--line);border-radius:6px;color:var(--text);text-align:center"
      oninput="setManualPrice('${t.ticker}', this.value)">
    <span style="font-family:var(--mono);font-size:9px;color:var(--t3)">‚Üí P&L</span>
  </div>`;
}

async function refreshLivePrices() {
  const op = cache.trades.filter(t => t.status === 'OPEN');
  if (!op.length) { toast('–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π'); return; }
  const btn = document.getElementById('liveBtn');
  if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
  const tickers = [...new Set(op.map(t => t.ticker))];
  toast('–ó–∞–≥—Ä—É–∂–∞—é —Ü–µ–Ω—ã...');
  try {
    const results = await fetchPricesViaClaude(tickers);
    results.forEach(r => {
      if (r.ticker && r.price) livePrices[r.ticker] = { price: r.price, change: r.change, rsi7: r.rsi7, rsi14: r.rsi14 };
    });
    // Update SPY RSI if found
    const spy = results.find(r => r.ticker === 'SPY');
    if (spy?.rsi14) { document.getElementById('spyRsi').value = spy.rsi14; updRegime(); }
    renderDash();
    toast('–¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úì');
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, true);
  } finally {
    if (btn) { btn.textContent = 'üì°'; btn.disabled = false; }
  }
}

async function fetchTickerData() {
  const ticker = document.getElementById('te_tk').value.trim().toUpperCase();
  if (!ticker) { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä!', true); return; }
  const btn = document.getElementById('fetchBtn');
  const status = document.getElementById('fetchStatus');
  btn.textContent = '‚è≥'; btn.disabled = true;
  status.style.display = ''; status.style.color = 'var(--t2)';
  status.textContent = '–ó–∞–≥—Ä—É–∂–∞—é ' + ticker + '...';
  try {
    const results = await fetchPricesViaClaude([ticker]);
    const r = results.find(x => x.ticker === ticker) || results[0];
    if (!r?.price) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
    document.getElementById('te_en').value = r.price.toFixed(2);
    if (r.rsi7  != null) document.getElementById('te_r7').value  = r.rsi7;
    if (r.rsi14 != null) document.getElementById('te_r14').value = r.rsi14;
    const spyVal = document.getElementById('spyRsi').value;
    if (spyVal) document.getElementById('te_spy').value = spyVal;
    status.style.color = 'var(--acc)';
    status.textContent = '‚úì ' + ticker + ': $' + r.price + ' (' + (r.change >= 0 ? '+' : '') + (r.change||0).toFixed(2) + '%) ¬∑ RSI7: ' + (r.rsi7||'‚Äî') + ' ¬∑ RSI14: ' + (r.rsi14||'‚Äî');
    tradeAutoCalc();
  } catch(e) {
    status.style.color = 'var(--acc2)';
    status.textContent = '‚úó ' + e.message;
  } finally {
    btn.textContent = 'üì° –¶–ï–ù–ê'; btn.disabled = false;
  }
}

async function testFinnhub() {
  const el = document.getElementById('fhStatus');
  el.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...'; el.style.color = 'var(--t2)';
  try {
    const results = await fetchPricesViaClaude(['SPY']);
    const r = results[0];
    if (r?.price) {
      el.textContent = '‚úì –†–∞–±–æ—Ç–∞–µ—Ç ‚Äî SPY: $' + r.price; el.style.color = 'var(--acc)';
    } else {
      el.textContent = '‚úó –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; el.style.color = 'var(--acc2)';
    }
  } catch(e) {
    el.textContent = '‚úó ' + e.message; el.style.color = 'var(--acc2)';
  }
}


// Track manually overridden fields so auto-calc doesn't overwrite them
const manualFields = new Set();
function tradeMarkManual(field) { manualFields.add(field); }
function resetShares() {
  manualFields.delete('sh');
  document.getElementById('te_sh').value = '';
  document.getElementById('te_sh_auto').textContent = '';
  tradeAutoCalc();
}

function toggleExitFields() {
  const status = document.getElementById('te_sta').value;
  const partialSection = document.getElementById('te_partial_section');
  const exitSection = document.getElementById('te_exit_section');
  const partialSummary = document.getElementById('te_partial_summary');
  
  // Hide all first
  partialSection.style.display = 'none';
  exitSection.style.display = 'none';
  
  if (status === 'PARTIAL') {
    partialSection.style.display = '';
    // Auto-fill 50% shares if we have total shares
    const totalShares = parseInt(document.getElementById('te_sh').value) || 0;
    const partialSharesEl = document.getElementById('te_p_shares');
    if (totalShares && !partialSharesEl.value) {
      partialSharesEl.value = Math.floor(totalShares / 2);
    }
    // Auto-fill date
    const partialDateEl = document.getElementById('te_p_date');
    if (!partialDateEl.value) {
      partialDateEl.value = today();
    }
    calcPartialPnl();
  } else if (status === 'CLOSED') {
    exitSection.style.display = '';
    // Show partial summary if exists
    const entry = parseFloat(document.getElementById('te_en').value) || 0;
    const partialPrice = parseFloat(document.getElementById('te_p_price').value) || 0;
    const partialShares = parseInt(document.getElementById('te_p_shares').value) || 0;
    if (partialPrice && partialShares && entry) {
      const type = document.getElementById('te_tp').value;
      const dir = type === 'LONG' ? 1 : -1;
      const partialPnl = dir * (partialPrice - entry) * partialShares;
      const partialPct = (dir * (partialPrice - entry) / entry * 100).toFixed(2);
      partialSummary.style.display = '';
      document.getElementById('te_partial_summary_content').innerHTML = 
        `${partialShares} –∞–∫—Ü–∏–π –ø–æ $${partialPrice.toFixed(2)} = <span class="${partialPnl>=0?'g':'r'}">${partialPnl>=0?'+':''}$${partialPnl.toFixed(0)} (${partialPct}%)</span>`;
    } else {
      partialSummary.style.display = 'none';
    }
    tradeAutoCalc();
  }
}

function calcPartialPnl() {
  const entry = parseFloat(document.getElementById('te_en').value) || 0;
  const type = document.getElementById('te_tp').value;
  const totalShares = parseInt(document.getElementById('te_sh').value) || 0;
  const partialPrice = parseFloat(document.getElementById('te_p_price').value) || 0;
  const partialShares = parseInt(document.getElementById('te_p_shares').value) || 0;
  const partialComm = parseFloat(document.getElementById('te_p_comm').value) || 0;
  
  const preview = document.getElementById('partial_pnl_preview');
  
  if (!entry || !partialPrice || !partialShares) {
    preview.style.display = 'none';
    return;
  }
  
  const dir = type === 'LONG' ? 1 : -1;
  const grossPnl = dir * (partialPrice - entry) * partialShares;
  const netPnl = grossPnl - partialComm;
  const pnlPct = (netPnl / (entry * partialShares) * 100).toFixed(2);
  const remaining = totalShares - partialShares;
  
  preview.style.display = '';
  document.getElementById('partial_pnl_value').innerHTML = 
    `<span class="${netPnl>=0?'g':'r'}">${netPnl>=0?'+':''}$${netPnl.toFixed(0)} (${pnlPct}%)</span>`;
  document.getElementById('partial_remaining').textContent = `${remaining} –∞–∫—Ü–∏–π`;
  document.getElementById('partial_new_stop').innerHTML = `$${entry.toFixed(2)} <span style="color:var(--t2);font-size:10px">(breakeven)</span>`;
}

function tradeAutoCalc() {
  const entry  = parseFloat(document.getElementById('te_en').value);
  const type   = document.getElementById('te_tp').value;
  const s      = getSets();

  const preview = document.getElementById('te_calc_preview');
  const rows    = document.getElementById('te_calc_rows');

  if (!entry || entry <= 0) { preview.style.display = 'none'; return; }

  const dir = type === 'LONG' ? 1 : -1;

  // Auto-fill stop if not manually set
  if (!manualFields.has('st')) {
    const stopPrice = entry * (1 - dir * s.stopPct / 100);
    document.getElementById('te_st').value = stopPrice.toFixed(2);
  }
  // Auto-fill target1
  if (!manualFields.has('t1')) {
    const t1 = entry * (1 + dir * s.target1 / 100);
    document.getElementById('te_t1').value = t1.toFixed(2);
  }
  // Auto-fill target2
  if (!manualFields.has('t2')) {
    const t2 = entry * (1 + dir * s.target2 / 100);
    document.getElementById('te_t2').value = t2.toFixed(2);
  }

  // Preview block
  const stop  = parseFloat(document.getElementById('te_st').value) || 0;
  const t1    = parseFloat(document.getElementById('te_t1').value) || 0;
  const t2    = parseFloat(document.getElementById('te_t2').value) || 0;
  const sh    = parseInt(document.getElementById('te_sh').value)   || 0;
  const stopPct = stop && entry ? Math.abs((stop-entry)/entry*100).toFixed(1) : '‚Äî';
  const t1Pct   = t1   && entry ? ((t1-entry)/entry*100*dir).toFixed(1) : '‚Äî';
  const t2Pct   = t2   && entry ? ((t2-entry)/entry*100*dir).toFixed(1) : '‚Äî';
  const posSize = sh * entry;
  const riskAmt = sh && stop ? Math.abs(sh * (entry - stop)) : 0;

  rows.innerHTML = [
    { l:'–°—Ç–æ–ø',     v:`$${stop.toFixed(2)}`, sub:`‚àí${stopPct}%`,  c:'var(--acc2)' },
    { l:'–¶–µ–ª—å 1',   v:`$${t1.toFixed(2)}`,   sub:`+${t1Pct}%`,    c:'var(--acc)'  },
    { l:'–¶–µ–ª—å 2',   v:`$${t2.toFixed(2)}`,   sub:`+${t2Pct}%`,    c:'var(--acc)'  },
    sh ? { l:'–ü–æ–∑–∏—Ü–∏—è',  v:`$${posSize.toFixed(0)}`, sub:`${sh} –∞–∫—Ü ¬∑ ${sh&&s.portfolio?(posSize/s.portfolio*100).toFixed(1):'‚Äî'}% –ø–æ—Ä—Ç.`, c:'var(--text)' } : null,
    sh && stop ? { l:'–†–∏—Å–∫ $', v:`$${riskAmt.toFixed(0)}`, sub:s.portfolio?`${(riskAmt/s.portfolio*100).toFixed(2)}% –ø–æ—Ä—Ç.`:'', c:'var(--acc3)' } : null,
  ].filter(Boolean).map(({l,v,sub,c}) => `<div style="min-width:80px">
    <div style="font-family:var(--mono);font-size:8px;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">${l}</div>
    <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${c}">${v}</div>
    <div style="font-family:var(--mono);font-size:9px;color:var(--t3)">${sub}</div>
  </div>`).join('');

  // Show formula basis
  const basisEl = document.getElementById('te_calc_basis');
  if (basisEl) {
    basisEl.innerHTML = `–ü–æ—Ä—Ç—Ñ–µ–ª—å: <b>$${s.portfolio.toLocaleString()}</b> ¬∑ –†–∏—Å–∫/—Å–¥–µ–ª–∫—É: <b>${s.riskPct}%</b> ($${(s.portfolio*s.riskPct/100).toFixed(0)}) ¬∑ –°—Ç–æ–ø: <b>${s.stopPct}%</b> ¬∑ –ú–∞–∫—Å –ø–æ–∑–∏—Ü–∏—è: <b>${s.maxPosPct}%</b> ($${(s.portfolio*s.maxPosPct/100).toFixed(0)})`;
  }
  preview.style.display = '';

  // P&L preview for exit (—Å –∫–æ–º–∏—Å—Å–∏—è–º–∏)
  const exitPrice = parseFloat(document.getElementById('te_ex')?.value);
  const comm      = parseFloat(document.getElementById('te_comm')?.value) || 0;
  const pnlFg = document.getElementById('pnl_preview_fg');
  const pnlEl = document.getElementById('pnl_preview');
  if (exitPrice && entry && pnlFg && pnlEl) {
    const grossPnl = dir * (exitPrice - entry) * (sh || 1);
    const netPnl   = grossPnl - comm;
    const basis    = entry * (sh || 1);
    const pnlPct   = netPnl / basis * 100;
    pnlFg.style.display = '';
    pnlEl.innerHTML = `<span style="color:${pnlPct>=0?'var(--acc)':'var(--acc2)'}">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%</span>`
      + (sh ? ` <span style="font-size:11px;color:var(--t2)">($${netPnl.toFixed(0)}${comm?` ¬∑ ‚àí$${comm} –∫–æ–º–∏—Å.`:''})</span>` : '');
  } else if (pnlFg) { pnlFg.style.display = 'none'; }
}

function openTrade(id=null) {
  manualFields.clear(); // reset all manual overrides including 'sh'
  document.getElementById('moTradeTitle').textContent = id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É' : '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞';
  document.getElementById('te_id').value = id || '';

  // Reset partial exit fields
  ['p_date','p_price','p_shares','p_comm'].forEach(f => {
    const el = document.getElementById('te_'+f); if(el) el.value = '';
  });
  const beCheckbox = document.getElementById('te_p_be');
  if (beCheckbox) beCheckbox.checked = false;

  if (id) {
    const t = cache.trades.find(x => x.id === id);
    if (t) {
      const map = {tk:'ticker',tp:'type',dt:'entryDate',en:'entry',sh:'shares',st:'stop',t1:'target1',t2:'target2',r7:'rsi7',r14:'rsi14',spy:'spyRsi',sta:'status',ex:'exitPrice',er:'exitReason',comm:'commission',nt:'notes'};
      Object.entries(map).forEach(([elId,key]) => {
        const el = document.getElementById('te_'+elId); if(el) el.value = t[key] || '';
      });
      // Load partial exit data
      if (t.partialExit) {
        document.getElementById('te_p_date').value = t.partialExit.date || '';
        document.getElementById('te_p_price').value = t.partialExit.price || '';
        document.getElementById('te_p_shares').value = t.partialExit.shares || '';
        document.getElementById('te_p_comm').value = t.partialExit.commission || '';
        if (beCheckbox) beCheckbox.checked = t.partialExit.breakevenSet || false;
      }
      // Mark existing prices as manually set (don't overwrite)
      if (t.stop)    manualFields.add('st');
      if (t.target1) manualFields.add('t1');
      if (t.target2) manualFields.add('t2');
    }
  } else {
    ['tk','en','sh','st','t1','t2','r7','r14','spy','ex','comm','nt'].forEach(f => {
      const el = document.getElementById('te_'+f); if(el) el.value = '';
    });
    document.getElementById('te_dt').value  = today();
    document.getElementById('te_tp').value  = 'LONG';
    document.getElementById('te_sta').value = 'OPEN';
    document.getElementById('te_er').value  = '';
    const rsi = document.getElementById('spyRsi').value;
    if (rsi) document.getElementById('te_spy').value = rsi;
  }

  toggleExitFields();
  tradeAutoCalc();
  openMo('moTrade');
}

async function saveTrade() {
  const ticker = document.getElementById('te_tk').value.trim().toUpperCase();
  if(!ticker) { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä!',true); return; }
  const id = document.getElementById('te_id').value;
  const map = {tk:'ticker',tp:'type',dt:'entryDate',en:'entry',sh:'shares',st:'stop',t1:'target1',t2:'target2',r7:'rsi7',r14:'rsi14',spy:'spyRsi',sta:'status',ex:'exitPrice',er:'exitReason',comm:'commission',nt:'notes'};
  const t = { id: id||Date.now().toString(), createdAt: Date.now() };
  Object.entries(map).forEach(([elId,key]) => { const el=document.getElementById('te_'+elId); if(el) t[key]=el.value; });
  t.ticker = ticker;
  t.entry      = parseFloat(t.entry)      || 0;
  t.exitPrice  = parseFloat(t.exitPrice)  || 0;
  t.shares     = parseInt(t.shares)       || 0;
  t.commission = parseFloat(t.commission) || 0;
  
  // Save partial exit data
  const partialPrice = parseFloat(document.getElementById('te_p_price').value) || 0;
  const partialShares = parseInt(document.getElementById('te_p_shares').value) || 0;
  const partialComm = parseFloat(document.getElementById('te_p_comm').value) || 0;
  const partialDate = document.getElementById('te_p_date').value;
  const breakevenSet = document.getElementById('te_p_be')?.checked || false;
  
  // Only save partialExit if there are actual values
  if (partialPrice > 0 && partialShares > 0) {
    t.partialExit = {
      date: partialDate,
      price: partialPrice,
      shares: partialShares,
      commission: partialComm,
      breakevenSet: breakevenSet
    };
  } else {
    delete t.partialExit;
  }
  
  // Calculate P&L based on status
  const dir = t.type === 'LONG' ? 1 : -1;
  
  if (t.status === 'PARTIAL' && t.partialExit) {
    // Only partial exit P&L (no commission deducted yet - will be on final close)
    const grossPnl = dir * (t.partialExit.price - t.entry) * t.partialExit.shares;
    t.partialExit.pnlNet = parseFloat(grossPnl.toFixed(2));
    t.partialExit.pnlPct = parseFloat((grossPnl / (t.entry * t.partialExit.shares) * 100).toFixed(2));
    // Position still open, no final result yet
    delete t.pnlPct;
    delete t.pnlNet;
    delete t.result;
  } else if (t.status === 'CLOSED' && t.exitPrice && t.entry && t.shares) {
    // Check if we have a valid partial exit
    const hasPartial = t.partialExit && t.partialExit.price > 0 && t.partialExit.shares > 0;
    
    if (hasPartial) {
      // Partial exit P&L (gross - no commission)
      const partialGrossPnl = dir * (t.partialExit.price - t.entry) * t.partialExit.shares;
      t.partialExit.pnlNet = parseFloat(partialGrossPnl.toFixed(2));
      t.partialExit.pnlPct = parseFloat((partialGrossPnl / (t.entry * t.partialExit.shares) * 100).toFixed(2));
      
      // Final exit with remaining shares
      const remainingShares = t.shares - t.partialExit.shares;
      const finalGrossPnl = dir * (t.exitPrice - t.entry) * remainingShares;
      
      // Total P&L = partial + final - ALL commissions
      const totalCommission = (t.partialExit.commission || 0) + (t.commission || 0);
      const totalGrossPnl = partialGrossPnl + finalGrossPnl;
      const totalNetPnl = totalGrossPnl - totalCommission;
      const totalBasis = t.entry * t.shares;
      t.pnlNet = parseFloat(totalNetPnl.toFixed(2));
      t.pnlPct = parseFloat((totalNetPnl / totalBasis * 100).toFixed(2));
    } else {
      // No partial exit - simple calculation
      const grossPnl = dir * (t.exitPrice - t.entry) * t.shares;
      const netPnl = grossPnl - t.commission;
      const basis = t.entry * t.shares;
      t.pnlNet = parseFloat(netPnl.toFixed(2));
      t.pnlPct = parseFloat((netPnl / basis * 100).toFixed(2));
    }
    t.result = t.pnlNet >= 0 ? 'WIN' : 'LOSS';
  } else if (t.status === 'OPEN') {
    // Open position - clear P&L
    delete t.pnlPct;
    delete t.pnlNet;
    delete t.result;
  }
  
  if(id) { const i=cache.trades.findIndex(x=>x.id===id); if(i>=0) cache.trades[i]=t; else cache.trades.unshift(t); }
  else cache.trades.unshift(t);
  scheduleSave(); const ok = true;
  if(ok) { closeMo('moTrade'); renderTrades(); renderDash(); toast(id?'–°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úì':'–°–¥–µ–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úì'); }
}

async function delTrade(id) {
  confirmDialog('–£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É?', async () => {
    cache.trades = cache.trades.filter(t=>t.id!==id);
    scheduleSave();
    renderTrades(); renderDash(); toast('–£–¥–∞–ª–µ–Ω–æ');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADING DAY LOGIC: T0 = entry day, T4 = exit day
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTradingDayNumber(entryDate) {
  // T0 = –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
  // T1, T2, T3 = —Å–ª–µ–¥—É—é—â–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –¥–Ω–∏
  // T4 = –¥–µ–Ω—å –∑–∞–∫—Ä—ã—Ç–∏—è (–º–∞–∫—Å–∏–º—É–º)
  if (!entryDate) return 0;
  
  const entryStr = typeof entryDate === 'string' ? entryDate : entryDate.toISOString().split('T')[0];
  const todayStr = today();
  
  // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤—Ö–æ–¥–∞ = —Å–µ–≥–æ–¥–Ω—è ‚Üí T0
  if (entryStr === todayStr) return 0;
  
  // –°—á–∏—Ç–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ –¥–Ω–∏ –º–µ–∂–¥—É entry –∏ today
  let count = 0;
  const d = new Date(entryStr);
  
  while (true) {
    d.setDate(d.getDate() + 1);
    const dateStr = d.toISOString().split('T')[0];
    
    if (dateStr > todayStr) break;
    
    if (isTradingDay(dateStr)) {
      count++;
    }
  }
  
  return count;
}

// Legacy alias for compatibility
function tradingDay(entryDate) {
  return getTradingDayNumber(entryDate);
}

// Get T-label for display
function getTLabel(entryDate) {
  const t = getTradingDayNumber(entryDate);
  return `T${t}`;
}

// Check if position should be closed (T4)
function isExitDay(entryDate) {
  return getTradingDayNumber(entryDate) >= 4;
}

// Get date for specific T-day from entry
function getDateForT(entryDate, targetT) {
  if (!entryDate) return null;
  const entryStr = typeof entryDate === 'string' ? entryDate : entryDate.toISOString().split('T')[0];
  
  if (targetT === 0) return entryStr;
  
  let count = 0;
  const d = new Date(entryStr);
  
  while (count < targetT) {
    d.setDate(d.getDate() + 1);
    const dateStr = d.toISOString().split('T')[0];
    if (isTradingDay(dateStr)) {
      count++;
    }
  }
  
  return d.toISOString().split('T')[0];
}

function renderTrades() {
  const tr = cache.trades;
  const tf = document.getElementById('fType')?.value||'';
  const sf = document.getElementById('fStatus')?.value||'';
  const rf = document.getElementById('fResult')?.value||'';
  const tk = (document.getElementById('fTicker')?.value||'').toUpperCase();
  const fl = tr.filter(t=>(!tf||t.type===tf)&&(!sf||t.status===sf)&&(!rf||t.result===rf)&&(!tk||t.ticker.includes(tk)));
  const tb = document.getElementById('tradesTb');
  if(!fl.length){ tb.innerHTML='<tr><td colspan="14" style="text-align:center;color:var(--t2);padding:36px">–°–¥–µ–ª–æ–∫ –Ω–µ—Ç</td></tr>'; return; }
  tb.innerHTML = fl.map(t => {
    // T-day logic: T0=entry, T4=exit
    const tDay = (t.status==='OPEN' || t.status==='PARTIAL') ? getTradingDayNumber(t.entryDate) : null;
    const tLabel = tDay !== null ? `T${tDay}` : '‚Äî';
    // Color: T0-T2 blue, T3 yellow, T4+ red
    const tColor = tDay === null ? '' : tDay <= 2 ? 'd1' : tDay === 3 ? 'd3' : 'd5';
    const db = tDay !== null ? `<span class="db ${tColor}">${tLabel}</span>` : '‚Äî';
    
    // P&L: –ø—Ä–æ—Ü–µ–Ω—Ç + –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let pnl = '<span style="color:var(--t2)">‚Äî</span>';
    if (t.pnlPct !== undefined) {
      const pctStr = `${t.pnlPct>0?'+':''}${t.pnlPct}%`;
      const netStr = t.pnlNet !== undefined ? `<span style="font-size:9px;color:var(--t2)"> ($${t.pnlNet>0?'+':''}${t.pnlNet.toFixed(0)})</span>` : '';
      pnl = `<span class="${t.pnlPct>=0?'g':'r'}">${pctStr}</span>${netStr}`;
    } else if (t.status === 'PARTIAL' && t.partialExit?.pnlNet !== undefined) {
      // Show partial P&L for PARTIAL status
      const pctStr = `${t.partialExit.pnlPct>0?'+':''}${t.partialExit.pnlPct}%`;
      const netStr = `<span style="font-size:9px;color:var(--t2)"> ($${t.partialExit.pnlNet>0?'+':''}${t.partialExit.pnlNet.toFixed(0)})</span>`;
      pnl = `<span class="${t.partialExit.pnlPct>=0?'g':'r'}">${pctStr}</span>${netStr}<div style="font-size:8px;color:var(--acc3);margin-top:2px">50% –∑–∞–∫—Ä—ã—Ç–æ</div>`;
    }
    // Status badge
    let stBadge;
    if (t.status === 'OPEN') {
      stBadge = '<span class="b b-open">–û–¢–ö–†–´–¢–ê</span>';
    } else if (t.status === 'PARTIAL') {
      stBadge = '<span class="b b-warn">–ß–ê–°–¢–ò–ß–ù.</span>';
    } else {
      stBadge = t.result === 'WIN' ? '<span class="b b-win">–í–´–ò–ì–†–´–®</span>' : '<span class="b b-loss">–£–ë–´–¢–û–ö</span>';
    }
    return `<tr>
      <td>${t.entryDate||'‚Äî'}</td>
      <td style="font-weight:700">${t.ticker}</td>
      <td><span class="b ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span></td>
      <td>$${t.entry||'‚Äî'}</td><td class="r">$${t.stop||'‚Äî'}</td>
      <td class="g">$${t.target1||'‚Äî'}</td><td class="g">$${t.target2||'‚Äî'}</td>
      <td>${t.rsi7||'‚Äî'}</td><td>${t.rsi14||'‚Äî'}</td><td>${t.spyRsi||'‚Äî'}</td>
      <td>${db}</td><td>${pnl}</td><td>${stBadge}</td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-g btn-s" onclick="openTrade('${t.id}')">‚úè</button>
        <button class="btn btn-d btn-s" onclick="delTrade('${t.id}')">‚úï</button>
      </div></td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash() {
  const tr = cache.trades;
  const cl = tr.filter(t=>t.status==='CLOSED'&&t.pnlPct!==undefined);
  const op = tr.filter(t=>t.status==='OPEN' || t.status==='PARTIAL');
  const wins = cl.filter(t=>t.result==='WIN');
  const loss = cl.filter(t=>t.result==='LOSS');
  const wr = cl.length ? ((wins.length/cl.length)*100).toFixed(1) : 0;
  const aw = wins.length ? (wins.reduce((a,t)=>a+t.pnlPct,0)/wins.length).toFixed(2) : 0;
  const al = loss.length ? (loss.reduce((a,t)=>a+t.pnlPct,0)/loss.length).toFixed(2) : 0;
  const tot = cl.reduce((a,t)=>a+(t.pnlPct||0),0).toFixed(2);
  
  // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π P&L –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö
  const totNet = cl.reduce((a,t)=>a+(t.pnlNet||0),0);
  const awNet = wins.length ? (wins.reduce((a,t)=>a+(t.pnlNet||0),0)/wins.length) : 0;
  const alNet = loss.length ? (loss.reduce((a,t)=>a+(t.pnlNet||0),0)/loss.length) : 0;

  // Holiday warning for dashboard
  let holidayAlert = '';
  const todayStr = today();
  if (isHoliday(todayStr)) {
    holidayAlert = `<div style="grid-column:1/-1;padding:14px 18px;background:rgba(255,107,138,.1);border:1px solid var(--acc2);border-radius:10px;font-family:var(--mono);font-size:12px;color:var(--acc2);display:flex;align-items:center;gap:10px">
      <span style="font-size:18px">üö´</span> –°–ï–ì–û–î–ù–Ø –ü–†–ê–ó–î–ù–ò–ö ‚Äî ${getHolidayName(todayStr)} ‚Äî –†–´–ù–û–ö –ó–ê–ö–†–´–¢
    </div>`;
  } else if (isEarlyClose(todayStr)) {
    holidayAlert = `<div style="grid-column:1/-1;padding:14px 18px;background:rgba(255,200,90,.1);border:1px solid var(--acc3);border-radius:10px;font-family:var(--mono);font-size:12px;color:var(--acc3);display:flex;align-items:center;gap:10px">
      <span style="font-size:18px">‚è∞</span> –°–ï–ì–û–î–ù–Ø –†–ê–ù–ù–ò–ô CLOSE ‚Äî 13:00 EST
    </div>`;
  } else if (isTomorrowHoliday()) {
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    holidayAlert = `<div style="grid-column:1/-1;padding:12px 16px;background:rgba(255,200,90,.08);border:1px solid var(--acc3);border-radius:10px;font-family:var(--mono);font-size:11px;color:var(--acc3);display:flex;align-items:center;gap:10px">
      <span style="font-size:16px">üìÖ</span> –ó–ê–í–¢–†–ê –ü–†–ê–ó–î–ù–ò–ö ‚Äî ${getHolidayName(tomorrowStr)} ‚Äî —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥–∞
    </div>`;
  }

  document.getElementById('statsGrid').innerHTML = holidayAlert + `
    <div class="stat" style="--sc:var(--acc4)"><div class="stat-l">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div><div class="stat-v">${tr.length}</div><div class="stat-s">${op.length} –æ—Ç–∫—Ä—ã—Ç—ã—Ö</div></div>
    <div class="stat" style="--sc:var(--acc)"><div class="stat-l">% –≤—ã–∏–≥—Ä—ã—à–µ–π</div><div class="stat-v g">${wr}%</div><div class="stat-s">${wins.length}W / ${loss.length}L</div></div>
    <div class="stat" style="--sc:var(--acc3)"><div class="stat-l">–°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à</div><div class="stat-v g">+${aw}%</div><div class="stat-s">$${awNet>=0?'+':''}${awNet.toFixed(0)} ¬∑ –£–±—ã—Ç–æ–∫: ${al}% ($${alNet.toFixed(0)})</div></div>
    <div class="stat" style="--sc:${parseFloat(tot)>=0?'var(--acc)':'var(--acc2)'}"><div class="stat-l">–°—É–º–º–∞—Ä–Ω—ã–π P&L</div><div class="stat-v ${parseFloat(tot)>=0?'g':'r'}">${parseFloat(tot)>0?'+':''}${tot}%</div><div class="stat-s">${totNet>=0?'+':''}$${totNet.toFixed(0)} –ø–æ –∑–∞–∫—Ä—ã—Ç—ã–º</div></div>`;

  const opEl = document.getElementById('openPos');
  if (!op.length) {
    opEl.innerHTML = '<div class="empty"><div class="empty-i">üì≠</div><div class="empty-t">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div></div>';
  } else {
    opEl.innerHTML = op.map(t => {
      const tDay   = getTradingDayNumber(t.entryDate);
      const entry  = parseFloat(t.entry)  || 0;
      const stop   = parseFloat(t.stop)   || 0;
      const t1     = parseFloat(t.target1)|| 0;
      const t2     = parseFloat(t.target2)|| 0;
      const shares = parseInt(t.shares)   || 0;
      const dir    = t.type === 'LONG' ? 1 : -1;

      // Current P&L estimate (we don't have live price, show vs targets)
      const pnlVsT1  = t1 && entry ? ((t1 - entry) / entry * 100 * dir).toFixed(1) : null;
      const pnlVsT2  = t2 && entry ? ((t2 - entry) / entry * 100 * dir).toFixed(1) : null;
      const stopPct  = stop && entry ? Math.abs((stop - entry) / entry * 100).toFixed(1) : null;

      // ‚îÄ‚îÄ Smart action hints (T0-T4 logic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const hints = [];

      // T0: entry day
      if (tDay === 0) {
        hints.push({ icon:'üöÄ', text:'T0 ‚Äî –¥–µ–Ω—å –≤—Ö–æ–¥–∞. –°—Ç–æ–ø-–ª–æ—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω!', color:'var(--acc4)', urgency:1 });
      }

      // T1: first day after entry
      if (tDay === 1) {
        hints.push({ icon:'üëÅ', text:'T1 ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –∂–¥—ë–º –¥–≤–∏–∂–µ–Ω–∏—è', color:'var(--acc4)', urgency:0 });
      }

      // T2: second day
      if (tDay === 2) {
        hints.push({ icon:'üëÅ', text:'T2 ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –¶–µ–ª–∏ 1', color:'var(--acc4)', urgency:0 });
        if (t1) hints.push({
          icon:'üéØ',
          text:`–¶–µ–ª—å 1 = $${t1.toFixed(2)} (+${pnlVsT1}%) ‚Üí –∑–∞–∫—Ä—ã—Ç—å 50%, —Å—Ç–æ–ø ‚Üí breakeven`,
          color:'var(--acc)', urgency:0
        });
      }

      // T3: warning day
      if (tDay === 3) {
        hints.push({
          icon:'üìÖ',
          text:`T3 ‚Äî –ó–ê–í–¢–†–ê T4 (–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å). –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –≤—ã—Ö–æ–¥—É`,
          color:'var(--acc3)', urgency:1
        });
      }

      // T4: mandatory exit day
      if (tDay >= 4) {
        hints.push({
          icon:'üö®',
          text:`T4 ‚Äî –í–´–•–û–î –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù —Å–µ–≥–æ–¥–Ω—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–∏ (16:00 EST) –ø–æ –ª—é–±–æ–π —Ü–µ–Ω–µ`,
          color:'var(--acc2)', urgency:3
        });
      }

      // Target 1 reminder (T1+)
      if (tDay >= 1 && tDay < 4 && t1) {
        hints.push({
          icon:'üéØ',
          text:`–¶–µ–ª—å 1: $${t1.toFixed(2)} (+${pnlVsT1}%) ‚Üí 50% –≤—ã—Ö–æ–¥, —Å—Ç–æ–ø ‚Üí breakeven`,
          color:'var(--acc)', urgency:0
        });
      }

      // Stop reminder always
      if (stop) {
        hints.push({
          icon:'üõë',
          text:`–°—Ç–æ–ø-–ª–æ—Å—Å: $${stop.toFixed(2)} (‚àí${stopPct}%) ‚Äî GTC –æ—Ä–¥–µ—Ä –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å`,
          color:'var(--t2)', urgency:0
        });
      }

      // Target 2 reminder
      if (t2 && tDay >= 1) {
        hints.push({
          icon:'üèÜ',
          text:`–¶–µ–ª—å 2: $${t2.toFixed(2)} (+${pnlVsT2}%) ‚Üí –∑–∞–∫—Ä—ã—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 50%`,
          color:'var(--acc)', urgency:0
        });
      }

      // Sort by urgency desc
      hints.sort((a,b) => b.urgency - a.urgency);

      const urgency = hints[0]?.urgency || 0;
      const borderCol = urgency >= 3 ? 'var(--acc2)' : urgency >= 2 ? 'rgba(255,107,138,.5)' : urgency >= 1 ? 'rgba(255,200,90,.4)' : 'var(--line)';
      
      // T-day color: T0-T2 blue, T3 yellow, T4+ red
      const tColor = tDay <= 2 ? 'd1' : tDay === 3 ? 'd3' : 'd5';
      const tLabel = `T${tDay}`;

      return `<div class="opc" style="border-color:${borderCol};margin-bottom:12px">
        <!-- Header row -->
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span style="font-size:17px;font-weight:800">${t.ticker}</span>
            <span class="b ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span>
            <span class="db ${tColor}">${tLabel}</span>
            <span style="font-family:var(--mono);font-size:9px;color:var(--t2)">${t.entryDate||''}</span>
            ${tDay >= 4 ? '<span style="font-family:var(--mono);font-size:9px;color:var(--acc2);font-weight:700;background:rgba(255,107,138,.15);padding:2px 6px;border-radius:4px">‚ö† –í–´–•–û–î –°–ï–ì–û–î–ù–Ø</span>' : ''}
          </div>
          <button class="btn btn-g btn-s" onclick="openTrade('${t.id}')">‚úè –û–ë–ù–û–í–ò–¢–¨</button>
        </div>

        <!-- Price row -->
        <div style="display:flex;gap:16px;margin-top:10px;flex-wrap:wrap;font-family:var(--mono);font-size:11px">
          <span>–í—Ö–æ–¥: <span style="color:var(--text);font-weight:700">$${entry||'‚Äî'}</span></span>
          <span>–°—Ç–æ–ø: <span class="r">$${stop||'‚Äî'}</span></span>
          <span>–¶1: <span class="g">$${t1||'‚Äî'}</span></span>
          <span>–¶2: <span class="g">$${t2||'‚Äî'}</span></span>
          ${shares ? `<span>–ê–∫—Ü–∏–π: <span style="color:var(--text)">${shares}</span></span>` : ''}
          ${shares && t1 ? `<span>¬Ω –∑–∞–∫—Ä—ã—Ç—å: <span style="color:var(--acc4)">${Math.ceil(shares/2)} —à—Ç.</span></span>` : ''}
        </div>

        <!-- Live price row -->
        ${(() => {
          const lp = livePrices[t.ticker];
          const dirAttr = dir === -1 ? '-1' : '1';
          const pnlDiv  = `<div data-ticker-pnl="${t.ticker}" data-entry="${entry}" data-shares="${shares}" data-dir="${dirAttr}" style="min-width:80px;min-height:18px">`
            + (lp?.price && entry
                ? (() => { const p=dir*(lp.price-entry)/entry*100; const col=p>=0?'var(--acc)':'var(--acc2)';
                    return `<span style="font-size:13px;font-weight:800;color:${col}">${p>=0?'+':''}${p.toFixed(2)}%</span>`
                      +(shares?` <span style="font-size:10px;color:var(--t2)">($${Math.abs(p/100*entry*shares).toFixed(0)})</span>`:''); })()
                : '')
            + `</div>`;

          const inputRow = `<div style="display:flex;align-items:center;gap:8px;margin-top:8px;padding:7px 10px;background:var(--bg3);border-radius:8px;border:1px solid var(--line);flex-wrap:wrap">
            <span style="font-family:var(--mono);font-size:9px;color:var(--t2);white-space:nowrap">–¢–µ–∫. —Ü–µ–Ω–∞ $</span>
            <input type="number" step=".01" placeholder="${entry||'0.00'}" value="${lp?.price||''}"
              style="width:90px;font-family:var(--mono);font-size:13px;font-weight:700;padding:3px 8px;background:var(--bg4);border:1px solid var(--line);border-radius:6px;color:var(--text);text-align:center"
              oninput="setManualPrice('${t.ticker}', this.value)">
            ${pnlDiv}
          </div>`;
          return inputRow;
        })()}

        <!-- Action hints -->
        ${hints.length ? `<div style="margin-top:10px;display:flex;flex-direction:column;gap:5px">
          ${hints.slice(0,4).map(h => `
            <div style="display:flex;align-items:flex-start;gap:7px;padding:7px 10px;border-radius:6px;background:rgba(255,255,255,.03);border-left:3px solid ${h.color}">
              <span style="flex-shrink:0">${h.icon}</span>
              <span style="font-family:var(--mono);font-size:10px;color:${h.urgency>=2?'var(--text)':'var(--t2)'};line-height:1.4">${h.text}</span>
            </div>`).join('')}
        </div>` : ''}
      </div>`;
    }).join('');
  }

  // Recent
  const rb = document.getElementById('recentTb');
  const rec = tr.slice(0,8);
  if(!rec.length){ rb.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--t2);padding:36px">–°–¥–µ–ª–æ–∫ –Ω–µ—Ç</td></tr>'; return; }
  rb.innerHTML = rec.map(t => {
    // T-day logic
    const tDay = (t.status==='OPEN' || t.status==='PARTIAL') ? getTradingDayNumber(t.entryDate) : null;
    const tLabel = tDay !== null ? `T${tDay}` : '‚Äî';
    const tColor = tDay === null ? '' : tDay <= 2 ? 'd1' : tDay === 3 ? 'd3' : 'd5';
    
    // P&L: –ø—Ä–æ—Ü–µ–Ω—Ç + –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let pnl = '‚Äî';
    if (t.pnlPct !== undefined) {
      const pctStr = `${t.pnlPct>0?'+':''}${t.pnlPct}%`;
      const netStr = t.pnlNet !== undefined ? `<div style="font-size:10px;color:var(--t2);margin-top:1px">$${t.pnlNet>0?'+':''}${t.pnlNet.toFixed(0)}</div>` : '';
      pnl = `<span class="${t.pnlPct>=0?'g':'r'}">${pctStr}</span>${netStr}`;
    } else if (t.status === 'PARTIAL' && t.partialExit?.pnlNet !== undefined) {
      const pctStr = `${t.partialExit.pnlPct>0?'+':''}${t.partialExit.pnlPct}%`;
      const netStr = `<div style="font-size:10px;color:var(--t2);margin-top:1px">$${t.partialExit.pnlNet>0?'+':''}${t.partialExit.pnlNet.toFixed(0)}</div>`;
      pnl = `<span class="${t.partialExit.pnlPct>=0?'g':'r'}">${pctStr}</span>${netStr}<div style="font-size:8px;color:var(--acc3)">50%</div>`;
    }
    // Status badge
    let stBadge;
    if (t.status === 'OPEN') {
      stBadge = '<span class="b b-open">–û–¢–ö–†–´–¢–ê</span>';
    } else if (t.status === 'PARTIAL') {
      stBadge = '<span class="b b-warn">–ß–ê–°–¢–ò–ß–ù.</span>';
    } else {
      stBadge = t.result === 'WIN' ? '<span class="b b-win">–í–´–ò–ì–†–´–®</span>' : '<span class="b b-loss">–£–ë–´–¢–û–ö</span>';
    }
    return `<tr>
      <td>${t.entryDate||'‚Äî'}</td><td style="font-weight:700">${t.ticker}</td>
      <td><span class="b ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span></td>
      <td>$${t.entry||'‚Äî'}</td><td>${t.exitPrice?'$'+t.exitPrice:'‚Äî'}</td>
      <td>${pnl}</td>
      <td>${tDay !== null ? `<span class="db ${tColor}">${tLabel}</span>` : '‚Äî'}</td>
      <td>${stBadge}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTRUMENTS STATISTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInstruments() {
  const trades = cache.trades.filter(t => t.status === 'CLOSED');
  const sortBy = document.getElementById('instrSort')?.value || 'trades';
  
  // Group by ticker
  const byTicker = {};
  trades.forEach(t => {
    const tk = t.ticker.toUpperCase();
    if (!byTicker[tk]) {
      byTicker[tk] = {
        ticker: tk,
        trades: [],
        totalPnl: 0,
        wins: 0,
        losses: 0
      };
    }
    byTicker[tk].trades.push(t);
    byTicker[tk].totalPnl += (t.pnlNet || 0);
    if (t.result === 'WIN') byTicker[tk].wins++;
    else if (t.result === 'LOSS') byTicker[tk].losses++;
  });
  
  // Calculate stats for each ticker
  const stats = Object.values(byTicker).map(g => {
    const sortedByEntry = [...g.trades].sort((a, b) => (a.entryDate || '').localeCompare(b.entryDate || ''));
    const sortedByExit = [...g.trades].filter(t => t.exitDate || t.exitPrice).sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''));
    
    const entryPrices = g.trades.map(t => t.entry).filter(p => p > 0);
    const exitPrices = g.trades.map(t => t.exitPrice).filter(p => p > 0);
    
    return {
      ticker: g.ticker,
      count: g.trades.length,
      wins: g.wins,
      losses: g.losses,
      firstEntry: sortedByEntry[0]?.entryDate || '‚Äî',
      lastEntry: sortedByEntry[sortedByEntry.length - 1]?.entryDate || '‚Äî',
      lastExit: sortedByExit[0]?.entryDate || '‚Äî', // Using entryDate as proxy for exit
      minEntry: entryPrices.length ? Math.min(...entryPrices) : 0,
      maxEntry: entryPrices.length ? Math.max(...entryPrices) : 0,
      minExit: exitPrices.length ? Math.min(...exitPrices) : 0,
      maxExit: exitPrices.length ? Math.max(...exitPrices) : 0,
      totalPnl: g.totalPnl
    };
  });
  
  // Sort
  if (sortBy === 'trades') stats.sort((a, b) => b.count - a.count);
  else if (sortBy === 'pnl') stats.sort((a, b) => b.totalPnl - a.totalPnl);
  else if (sortBy === 'ticker') stats.sort((a, b) => a.ticker.localeCompare(b.ticker));
  else if (sortBy === 'lastTrade') stats.sort((a, b) => (b.lastEntry || '').localeCompare(a.lastEntry || ''));
  
  const tb = document.getElementById('instrTb');
  if (!stats.length) {
    tb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--t2);padding:36px">–ù–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫</td></tr>';
    return;
  }
  
  tb.innerHTML = stats.map(s => {
    const pnlClass = s.totalPnl >= 0 ? 'g' : 'r';
    const pnlSign = s.totalPnl >= 0 ? '+' : '';
    const winRate = s.count > 0 ? ((s.wins / s.count) * 100).toFixed(0) : 0;
    
    return `<tr>
      <td style="font-weight:700">${s.ticker}</td>
      <td>${s.count}</td>
      <td><span class="g">${s.wins}W</span> / <span class="r">${s.losses}L</span> <span style="color:var(--t2);font-size:10px">(${winRate}%)</span></td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--t2)">${s.firstEntry}</td>
      <td style="font-family:var(--mono);font-size:11px">${s.lastEntry}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--t2)">${s.lastExit}</td>
      <td style="font-family:var(--mono);font-size:11px">${s.minEntry > 0 ? `$${s.minEntry.toFixed(2)} / $${s.maxEntry.toFixed(2)}` : '‚Äî'}</td>
      <td style="font-family:var(--mono);font-size:11px">${s.minExit > 0 ? `$${s.minExit.toFixed(2)} / $${s.maxExit.toFixed(2)}` : '‚Äî'}</td>
      <td style="font-family:var(--mono);font-weight:700" class="${pnlClass}">${pnlSign}$${s.totalPnl.toFixed(2)}</td>
    </tr>`;
  }).join('');
}

// Legacy function - now empty
function initChecklist() {
  renderInstruments();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WATCHLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Blackout = earnings date is within next 6 calendar days FROM today
function isBlackout(w) {
  if (!w.earningsDate) return false;
  const td  = new Date(today());
  const ear = new Date(w.earningsDate);
  const diffDays = Math.round((ear - td) / 86400000);
  return diffDays >= 0 && diffDays <= 6;  // 0..6 days ahead
}

// Cooldown = cooldownDate is set and >= today
function isCooldown(w) {
  if (!w.cooldownDate) return false;
  return w.cooldownDate >= today() && !isBlackout(w);
}

function openWL(ticker = null) {
  document.getElementById('wl_orig_ticker').value = ticker || '';
  const isEdit = !!ticker;
  document.getElementById('moWLTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ü–∏—é' : '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ü–∏—é';
  document.getElementById('wlSaveBtn').textContent = isEdit ? '–°–û–•–†–ê–ù–ò–¢–¨' : '–î–û–ë–ê–í–ò–¢–¨';

  if (isEdit) {
    const w = cache.watchlist.find(x => x.ticker === ticker);
    if (w) {
      document.getElementById('wl_tk').value  = w.ticker      || '';
      document.getElementById('wl_se').value  = w.sector      || '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏';
      document.getElementById('wl_cap').value = w.cap         || '';
      document.getElementById('wl_bt').value  = w.beta        || '';
      document.getElementById('wl_bo').value  = w.earningsDate|| '';
      document.getElementById('wl_cd').value  = w.cooldownDate|| '';
      document.getElementById('wl_nt').value  = w.notes       || '';
    }
  } else {
    ['tk','cap','bt','bo','cd','nt'].forEach(f => {
      const el = document.getElementById('wl_'+f); if(el) el.value = '';
    });
    document.getElementById('wl_se').value = '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏';
  }
  openMo('moWL');
}

async function saveWL() {
  const ticker = document.getElementById('wl_tk').value.trim().toUpperCase();
  if (!ticker) { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä!', true); return; }

  const origTicker = document.getElementById('wl_orig_ticker').value;
  const isEdit = !!origTicker;

  const item = {
    ticker,
    sector:       document.getElementById('wl_se').value,
    cap:          document.getElementById('wl_cap').value,
    beta:         document.getElementById('wl_bt').value,
    earningsDate: document.getElementById('wl_bo').value,   // renamed from blackoutDate
    cooldownDate: document.getElementById('wl_cd').value,
    notes:        document.getElementById('wl_nt').value,
    addedAt:      Date.now()
  };

  if (isEdit) {
    const idx = cache.watchlist.findIndex(w => w.ticker === origTicker);
    if (idx >= 0) {
      item.addedAt = cache.watchlist[idx].addedAt; // preserve original add date
      cache.watchlist[idx] = item;
    }
  } else {
    if (cache.watchlist.find(w => w.ticker === ticker)) {
      toast('–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ!', true); return;
    }
    cache.watchlist.unshift(item);
  }

  scheduleSave(); const ok = true;
  if (ok) {
    closeMo('moWL');
    renderWL();
    toast(isEdit ? `${ticker} –æ–±–Ω–æ–≤–ª—ë–Ω ‚úì` : `${ticker} –¥–æ–±–∞–≤–ª–µ–Ω ‚úì`);
  }
}

function delWL(ticker) {
  confirmDialog(`–£–¥–∞–ª–∏—Ç—å ${ticker} –∏–∑ –≤–æ—Ç—á–ª–∏—Å—Ç–∞?`, () => {
    cache.watchlist = cache.watchlist.filter(w => w.ticker !== ticker);
    scheduleSave();
    renderWL(); toast(`${ticker} —É–¥–∞–ª—ë–Ω`);
  });
}

function renderWL() {
  const wl  = cache.watchlist;
  const srch = (document.getElementById('wlSrch')?.value  || '').toUpperCase();
  const sect = document.getElementById('wlSect')?.value   || '';
  const stat = document.getElementById('wlStat')?.value   || '';

  // Get tickers with open positions
  const openPositionTickers = new Set(
    cache.trades
      .filter(t => t.status === 'OPEN' || t.status === 'PARTIAL')
      .map(t => t.ticker.toUpperCase())
  );

  // Count stats on full list before filtering
  let bo = 0, cd = 0, op = 0;
  wl.forEach(w => {
    if (openPositionTickers.has(w.ticker.toUpperCase())) op++;
    else if (isBlackout(w))  bo++;
    else if (isCooldown(w))  cd++;
  });

  document.getElementById('wlTot').textContent = wl.length;
  document.getElementById('wlOp').textContent  = op;
  document.getElementById('wlBo').textContent  = bo;
  document.getElementById('wlCd').textContent  = cd;
  document.getElementById('wlAct').textContent = wl.length - bo - cd - op;

  const fl = wl.filter(w => {
    const hasPosition = openPositionTickers.has(w.ticker.toUpperCase());
    const boBool = isBlackout(w);
    const cdBool = isCooldown(w);
    const st = hasPosition ? 'position' : boBool ? 'blackout' : cdBool ? 'cooldown' : 'active';
    return (!srch || w.ticker.includes(srch))
        && (!sect || w.sector === sect)
        && (!stat || stat === st);
  });

  const grid = document.getElementById('wlGrid');
  if (!fl.length) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1"><div class="empty-i">üìã</div><div class="empty-t">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div></div>';
    return;
  }

  grid.innerHTML = fl.map(w => {
    const hasPosition = openPositionTickers.has(w.ticker.toUpperCase());
    const boBool = isBlackout(w);
    const cdBool = isCooldown(w);
    const cls  = hasPosition ? 'op' : boBool ? 'bo' : cdBool ? 'cd' : '';
    let statusText, statusColor;
    
    if (hasPosition) {
      // Find the open trade to show T-day
      const trade = cache.trades.find(t => 
        t.ticker.toUpperCase() === w.ticker.toUpperCase() && 
        (t.status === 'OPEN' || t.status === 'PARTIAL')
      );
      const tDay = trade ? getTradingDayNumber(trade.entryDate) : '?';
      const isPartial = trade?.status === 'PARTIAL';
      statusText  = `üìà –û–¢–ö–†–´–¢–ê –ü–û–ó–ò–¶–ò–Ø ¬∑ T${tDay}${isPartial ? ' ¬∑ 50% –∑–∞–∫—Ä—ã—Ç–æ' : ''}`;
      statusColor = 'var(--acc4)';
    } else if (boBool) {
      // Show how many days until earnings
      const ear  = new Date(w.earningsDate);
      const diff = Math.round((ear - new Date(today())) / 86400000);
      statusText  = diff === 0 ? 'üö´ –û—Ç—á—ë—Ç –°–ï–ì–û–î–ù–Ø' : `üö´ –û—Ç—á—ë—Ç —á–µ—Ä–µ–∑ ${diff}–¥ (${w.earningsDate})`;
      statusColor = 'var(--acc2)';
    } else if (cdBool) {
      statusText  = `‚è≥ –ö—É–ª–¥–∞—É–Ω –¥–æ ${w.cooldownDate}`;
      statusColor = 'var(--acc3)';
    } else {
      statusText  = '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞';
      statusColor = 'var(--acc)';
      // Show upcoming earnings if set but not yet in blackout window
      if (w.earningsDate && w.earningsDate >= today()) {
        const diff = Math.round((new Date(w.earningsDate) - new Date(today())) / 86400000);
        statusText += ` ¬∑ üìÖ –æ—Ç—á—ë—Ç +${diff}–¥`;
      }
    }

    return `<div class="wi ${cls}">
      <div style="position:absolute;top:8px;right:8px;display:flex;gap:4px">
        <button class="wr" style="position:static;font-size:12px" onclick="openWL('${w.ticker}')">‚úè</button>
        <button class="wr" style="position:static" onclick="delWL('${w.ticker}')">‚úï</button>
      </div>
      <div class="wt">${w.ticker}${hasPosition ? ' <span style="font-size:10px;color:var(--acc4);font-weight:600">‚óè OPEN</span>' : ''}</div>
      <div class="wm">${w.sector||'‚Äî'} ¬∑ Œ≤${w.beta||'‚Äî'}${w.cap ? ' ¬∑ $'+w.cap+'B' : ''}</div>
      <div style="font-family:var(--mono);font-size:9px;color:${statusColor};line-height:1.5">${statusText}</div>
      ${w.notes ? `<div style="font-family:var(--mono);font-size:9px;color:var(--t3);margin-top:4px">${w.notes}</div>` : ''}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RSI DAILY SCAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getRsiColor(val) {
  if (val === '' || val === null || isNaN(val)) return 'var(--t3)';
  if (val <= 20) return 'var(--acc)';   // oversold ‚Äî long signal zone
  if (val <= 30) return 'var(--acc)';   // approaching
  if (val >= 80) return 'var(--acc2)';  // overbought ‚Äî short signal zone
  if (val >= 70) return 'var(--acc2)';
  return 'var(--acc3)';                 // neutral
}

function computeSignal(w, scan) {
  // T0 = —Å–µ–≥–æ–¥–Ω—è (–¥–µ–Ω—å –≤—Ö–æ–¥–∞ –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª)
  // T-1 = –≤—á–µ—Ä–∞ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–æ—Ä–≥–æ–≤—ã–π –¥–µ–Ω—å)
  // scan = { rsi7: T0 value, rsi7prev: T-1 value, rsi14: T0 value }
  const { rsi7, rsi7prev, rsi14 } = scan;
  if (rsi7 === '' || rsi14 === '') return 'none';

  const r7  = parseFloat(rsi7);     // RSI(7) –Ω–∞ T0
  const r7p = parseFloat(rsi7prev); // RSI(7) –Ω–∞ T-1
  const r14 = parseFloat(rsi14);    // RSI(14) –Ω–∞ T0
  if (isNaN(r7) || isNaN(r14)) return 'none';

  // LONG SIGNAL: RSI(7) –ø–µ—Ä–µ—Å—ë–∫ 20 —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (T-1 < 20, T0 > 20) –ò RSI(14) < 40
  // ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –°–ï–ì–û–î–ù–Ø (T0)
  if (!isNaN(r7p) && r7p < 20 && r7 > 20 && r14 < 40) return 'LONG_SIGNAL';

  // SHORT SIGNAL: RSI(7) –ø–µ—Ä–µ—Å—ë–∫ 80 —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ (T-1 > 80, T0 < 80) –ò RSI(14) > 60
  // ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –°–ï–ì–û–î–ù–Ø (T0)
  if (!isNaN(r7p) && r7p > 80 && r7 < 80 && r14 > 60) return 'SHORT_SIGNAL';

  // WATCH LONG: RSI(7) < 25 ‚Äî –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –∑–æ–Ω–µ —Å–∏–≥–Ω–∞–ª–∞
  if (r7 < 25) return 'WATCH_LONG';

  // WATCH SHORT: RSI(7) > 75 ‚Äî –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –∑–æ–Ω–µ —Å–∏–≥–Ω–∞–ª–∞
  if (r7 > 75) return 'WATCH_SHORT';

  return 'none';
}

function renderRsiScan() {
  const t0 = today(); // T0 = —Å–µ–≥–æ–¥–Ω—è
  document.getElementById('scanDateLabel').textContent = 'T0: ' + new Date().toLocaleDateString('ru-RU',{weekday:'short',day:'2-digit',month:'short'});

  const wl = cache.watchlist;
  if (!wl.length) {
    document.getElementById('rsiScanTbody').innerHTML =
      '<tr><td colspan="7" style="text-align:center;color:var(--t2);padding:30px">–î–æ–±–∞–≤—å—Ç–µ –∞–∫—Ü–∏–∏ –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</td></tr>';
    return;
  }

  const scans = cache.rsiScans || {};
  const t0Scan = scans[t0] || {};           // T0 = —Å–µ–≥–æ–¥–Ω—è
  const tMinus1 = getPrevDate(t0);          // T-1 = –≤—á–µ—Ä–∞
  const tMinus1Scan = scans[tMinus1] || {};

  // Build last 5 trading days history (T-1 to T-5)
  const histDates = [];
  let d = t0;
  for (let i = 0; i < 5; i++) { d = getPrevDate(d); histDates.push(d); }

  // Get tickers with open positions
  const openPositionTickers = new Set(
    cache.trades
      .filter(t => t.status === 'OPEN' || t.status === 'PARTIAL')
      .map(t => t.ticker.toUpperCase())
  );

  document.getElementById('rsiScanTbody').innerHTML = wl.map(w => {
    const boBool = isBlackout(w);
    const cdBool = isCooldown(w);
    const hasPosition = openPositionTickers.has(w.ticker.toUpperCase());
    const inactive = boBool || cdBool;

    const r7cur  = t0Scan[w.ticker + '_r7']  ?? '';      // RSI(7) –Ω–∞ T0
    const r14cur = t0Scan[w.ticker + '_r14'] ?? '';      // RSI(14) –Ω–∞ T0
    const r7prev = tMinus1Scan[w.ticker + '_r7'] ?? '';  // RSI(7) –Ω–∞ T-1

    const sig = inactive ? 'blocked' : hasPosition ? 'position' : computeSignal(w, { rsi7: r7cur, rsi7prev: r7prev, rsi14: r14cur });

    let sigHtml;
    switch(sig) {
      case 'LONG_SIGNAL':  sigHtml = '<span class="sig-long">üü¢ –õ–û–ù–ì ‚Üí –í–•–û–î T0</span>'; break;
      case 'SHORT_SIGNAL': sigHtml = '<span class="sig-short">üî¥ –®–û–†–¢ ‚Üí –í–•–û–î T0</span>'; break;
      case 'WATCH_LONG':   sigHtml = '<span class="sig-watch">üëÄ –°–õ–ï–î–ò–ú –õ–û–ù–ì</span>'; break;
      case 'WATCH_SHORT':  sigHtml = '<span class="sig-watch">üëÄ –°–õ–ï–î–ò–ú –®–û–†–¢</span>'; break;
      case 'blocked':      sigHtml = `<span class="sig-none">${boBool ? 'üö´ –ë–õ–≠–ö–ê–£–¢' : '‚è≥ –ö–£–õ–î–ê–£–ù'}</span>`; break;
      case 'position':     
        const trade = cache.trades.find(t => t.ticker.toUpperCase() === w.ticker.toUpperCase() && (t.status === 'OPEN' || t.status === 'PARTIAL'));
        const tDay = trade ? getTradingDayNumber(trade.entryDate) : '?';
        sigHtml = `<span class="sig-position">üìà –ü–û–ó–ò–¶–ò–Ø T${tDay}</span>`; 
        break;
      default:             sigHtml = '<span class="sig-none">‚Äî</span>';
    }

    const stText = hasPosition ? `<span class="bl" style="font-size:9px;font-family:var(--mono)">–ü–û–ó–ò–¶–ò–Ø</span>`
                 : boBool ? `<span class="r" style="font-size:9px;font-family:var(--mono)">–ë–õ–≠–ö–ê–£–¢</span>`
                 : cdBool ? `<span class="y" style="font-size:9px;font-family:var(--mono)">–ö–£–õ–î–ê–£–ù</span>`
                 : `<span class="g" style="font-size:9px;font-family:var(--mono)">–ê–ö–¢–ò–í–ù–ê</span>`;

    const r7color  = getRsiColor(r7cur  !== '' ? parseFloat(r7cur)  : NaN);
    const r14color = getRsiColor(r14cur !== '' ? parseFloat(r14cur) : NaN);

    const rowBg = hasPosition ? 'background:rgba(91,156,246,.06)' :
                  sig === 'LONG_SIGNAL'  ? 'background:rgba(126,232,162,.04)' :
                  sig === 'SHORT_SIGNAL' ? 'background:rgba(255,107,138,.04)' :
                  sig === 'WATCH_LONG' || sig === 'WATCH_SHORT' ? 'background:rgba(255,200,90,.03)' : '';

    // Build 5-day history sparkline for RSI(7) - with editable inputs
    const histVals = histDates.map(dt => {
      const v = (scans[dt] || {})[w.ticker + '_r7'];
      return v !== undefined && v !== '' ? parseFloat(v) : null;
    });

    const histHtml = `<div style="display:flex;align-items:center;gap:4px">
      ${histVals.map((v, i) => {
        const dateStr = histDates[i];
        const tLabel = `T-${i+1}`;
        if (v === null) {
          // Editable empty cell - click to add historical RSI
          return `<div style="display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer" onclick="editHistRsi('${w.ticker}','${dateStr}')" title="–î–æ–±–∞–≤–∏—Ç—å RSI –∑–∞ ${dateStr}">
            <div style="width:22px;height:28px;background:var(--bg4);border-radius:3px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--line)">
              <span style="font-family:var(--mono);font-size:10px;color:var(--t3)">+</span>
            </div>
            <span style="font-family:var(--mono);font-size:7px;color:var(--t3)">${tLabel}</span>
            <span style="font-family:var(--mono);font-size:6px;color:var(--t3)">${dateStr.slice(5)}</span>
          </div>`;
        }
        const barH = Math.round((v / 100) * 28);
        const col  = getRsiColor(v);
        return `<div title="${dateStr}: RSI7=${v.toFixed(1)} ‚Äî –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" style="display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer" onclick="editHistRsi('${w.ticker}','${dateStr}')">
          <div style="width:22px;height:28px;background:var(--bg4);border-radius:3px;display:flex;align-items:flex-end;overflow:hidden">
            <div style="width:100%;height:${barH}px;background:${col};border-radius:2px;transition:height .3s"></div>
          </div>
          <span style="font-family:var(--mono);font-size:7px;color:${col};font-weight:700">${v.toFixed(0)}</span>
          <span style="font-family:var(--mono);font-size:6px;color:var(--t3)">${tLabel}</span>
        </div>`;
      }).join('')}
      ${r7cur !== '' ? `<div style="display:flex;flex-direction:column;align-items:center;gap:2px;margin-left:2px;border-left:1px solid var(--line);padding-left:4px">
        <div style="width:22px;height:28px;background:var(--bg4);border-radius:3px;display:flex;align-items:flex-end;overflow:hidden;border:1px solid ${r7color}40">
          <div style="width:100%;height:${Math.round((parseFloat(r7cur)/100)*28)}px;background:${r7color};border-radius:2px"></div>
        </div>
        <span style="font-family:var(--mono);font-size:7px;color:${r7color};font-weight:700">${parseFloat(r7cur).toFixed(0)}</span>
        <span style="font-family:var(--mono);font-size:6px;color:var(--acc)">T0</span>
      </div>` : ''}
    </div>`;

    return `<tr style="${rowBg}">
      <td style="font-weight:700">${w.ticker}${hasPosition ? ' <span style="color:var(--acc4);font-size:9px">‚óè</span>' : ''}</td>
      <td style="color:var(--t2)">${w.sector||'‚Äî'}</td>
      <td>
        <div class="rsi-bar-wrap">
          <input class="rsi-inp" type="number" min="0" max="100" step="0.1"
            value="${r7cur}" placeholder="‚Äî"
            onchange="updateRsiScan('${w.ticker}','r7',this.value)"
            ${inactive ? 'disabled style="opacity:.4"' : ''}>
          ${r7cur !== '' ? `<div class="rsi-mini"><div class="rsi-mini-fill" style="width:${Math.min(100,parseFloat(r7cur)||0)}%;background:${r7color}"></div></div><span class="rsi-val" style="color:${r7color}">${parseFloat(r7cur).toFixed(0)}</span>` : ''}
        </div>
      </td>
      <td>
        <div class="rsi-bar-wrap">
          <input class="rsi-inp" type="number" min="0" max="100" step="0.1"
            value="${r14cur}" placeholder="‚Äî"
            onchange="updateRsiScan('${w.ticker}','r14',this.value)"
            ${inactive ? 'disabled style="opacity:.4"' : ''}>
          ${r14cur !== '' ? `<div class="rsi-mini"><div class="rsi-mini-fill" style="width:${Math.min(100,parseFloat(r14cur)||0)}%;background:${r14color}"></div></div><span class="rsi-val" style="color:${r14color}">${parseFloat(r14cur).toFixed(0)}</span>` : ''}
        </div>
      </td>
      <td style="padding:8px 14px">${histHtml}</td>
      <td>${sigHtml}</td>
      <td>${stText}</td>
    </tr>`;
  }).join('');

  renderDashSignals();
}

function updateRsiScan(ticker, field, value) {
  const t0 = today(); // T0 = —Å–µ–≥–æ–¥–Ω—è
  if (!cache.rsiScans) cache.rsiScans = {};
  if (!cache.rsiScans[t0]) cache.rsiScans[t0] = {};
  cache.rsiScans[t0][ticker + '_' + field] = value === '' ? '' : parseFloat(value);
  // Update signal cell in this row live
  const rows = document.querySelectorAll('#rsiScanTbody tr');
  const wl = cache.watchlist;
  rows.forEach((row, i) => {
    if (!wl[i]) return;
    if (wl[i].ticker !== ticker && !row.querySelector(`[onchange*="'${ticker}'"]`)) return;
    // find by ticker in first cell
    if (row.cells[0]?.textContent?.trim() !== ticker) return;
    const scans = cache.rsiScans || {};
    const t0Scan = scans[t0] || {};
    const tMinus1 = getPrevDate(t0);
    const tMinus1Scan = scans[tMinus1] || {};
    const r7cur  = t0Scan[ticker + '_r7']  ?? '';
    const r7prev = tMinus1Scan[ticker + '_r7'] ?? '';
    const r14cur = t0Scan[ticker + '_r14'] ?? '';
    const sig = computeSignal(wl[i], { rsi7: r7cur, rsi7prev: r7prev, rsi14: r14cur });
    // Update signal cell (index 5)
    const sigCell = row.cells[5];
    if (sigCell) {
      switch(sig) {
        case 'LONG_SIGNAL':  sigCell.innerHTML = '<span class="sig-long">üü¢ –õ–û–ù–ì –°–ò–ì–ù–ê–õ</span>'; break;
        case 'SHORT_SIGNAL': sigCell.innerHTML = '<span class="sig-short">üî¥ –®–û–†–¢ –°–ò–ì–ù–ê–õ</span>'; break;
        case 'WATCH_LONG':   sigCell.innerHTML = '<span class="sig-watch">üëÄ –°–õ–ï–î–ò–ú –õ–û–ù–ì</span>'; break;
        case 'WATCH_SHORT':  sigCell.innerHTML = '<span class="sig-watch">üëÄ –°–õ–ï–î–ò–ú –®–û–†–¢</span>'; break;
        default:             sigCell.innerHTML = '<span class="sig-none">‚Äî</span>';
      }
      // row highlight
      const bg = sig === 'LONG_SIGNAL'  ? 'rgba(126,232,162,.04)' :
                 sig === 'SHORT_SIGNAL' ? 'rgba(255,107,138,.04)' :
                 (sig.includes('WATCH'))? 'rgba(255,200,90,.03)'  : '';
      row.style.background = bg;
    }
    // Update mini bar in changed cell
    const colIdx = field === 'r7' ? 2 : 3;
    const cell = row.cells[colIdx];
    if (cell && value !== '') {
      const color = getRsiColor(parseFloat(value));
      const barWrap = cell.querySelector('.rsi-bar-wrap');
      if (barWrap) {
        let mini = barWrap.querySelector('.rsi-mini');
        let val  = barWrap.querySelector('.rsi-val');
        if (!mini) {
          mini = document.createElement('div'); mini.className = 'rsi-mini'; barWrap.appendChild(mini);
          val  = document.createElement('span'); val.className  = 'rsi-val';  barWrap.appendChild(val);
        }
        mini.innerHTML = `<div class="rsi-mini-fill" style="width:${Math.min(100,parseFloat(value)||0)}%;background:${color}"></div>`;
        val.textContent = parseFloat(value).toFixed(0);
        val.style.color = color;
      }
    }
  });
  renderDashSignals();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORICAL RSI EDITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function editHistRsi(ticker, dateStr) {
  document.getElementById('histRsi_ticker').value = ticker;
  document.getElementById('histRsi_date').value = dateStr;
  document.getElementById('histRsiTicker').textContent = ticker;
  document.getElementById('histRsiDate').textContent = dateStr;
  
  // Load existing values
  const scans = cache.rsiScans || {};
  const dayScan = scans[dateStr] || {};
  document.getElementById('histRsi_r7').value = dayScan[ticker + '_r7'] ?? '';
  document.getElementById('histRsi_r14').value = dayScan[ticker + '_r14'] ?? '';
  
  openMo('moHistRsi');
}

function saveHistRsi() {
  const ticker = document.getElementById('histRsi_ticker').value;
  const dateStr = document.getElementById('histRsi_date').value;
  const r7 = document.getElementById('histRsi_r7').value;
  const r14 = document.getElementById('histRsi_r14').value;
  
  if (!cache.rsiScans) cache.rsiScans = {};
  if (!cache.rsiScans[dateStr]) cache.rsiScans[dateStr] = {};
  
  if (r7 !== '') {
    cache.rsiScans[dateStr][ticker + '_r7'] = parseFloat(r7);
  } else {
    delete cache.rsiScans[dateStr][ticker + '_r7'];
  }
  
  if (r14 !== '') {
    cache.rsiScans[dateStr][ticker + '_r14'] = parseFloat(r14);
  } else {
    delete cache.rsiScans[dateStr][ticker + '_r14'];
  }
  
  scheduleSave();
  closeMo('moHistRsi');
  renderRsiScan();
  toast(`RSI –∑–∞ ${dateStr} —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì`);
}

function clearHistRsi() {
  const ticker = document.getElementById('histRsi_ticker').value;
  const dateStr = document.getElementById('histRsi_date').value;
  
  if (cache.rsiScans && cache.rsiScans[dateStr]) {
    delete cache.rsiScans[dateStr][ticker + '_r7'];
    delete cache.rsiScans[dateStr][ticker + '_r14'];
  }
  
  scheduleSave();
  closeMo('moHistRsi');
  renderRsiScan();
  toast(`RSI –∑–∞ ${dateStr} –æ—á–∏—â–µ–Ω`);
}

async function saveRsiScan() {
  const td = today();
  // Flush all current input values into cache before saving
  if (!cache.rsiScans) cache.rsiScans = {};
  if (!cache.rsiScans[td]) cache.rsiScans[td] = {};
  document.querySelectorAll('#rsiScanTbody tr').forEach(row => {
    const ticker = row.cells[0]?.textContent?.trim();
    if (!ticker) return;
    const inp7  = row.cells[2]?.querySelector('input');
    const inp14 = row.cells[3]?.querySelector('input');
    if (inp7  && inp7.value  !== '') cache.rsiScans[td][ticker + '_r7']  = parseFloat(inp7.value);
    if (inp14 && inp14.value !== '') cache.rsiScans[td][ticker + '_r14'] = parseFloat(inp14.value);
  });
  await persistToCloud();
  renderRsiScan();
  toast('RSI —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì');
}

function renderDashSignals() {
  const td = today();
  const scans = cache.rsiScans || {};
  const todayScan  = scans[td]          || {};
  const yesterday  = getPrevDate(td);
  const yesterScan = scans[yesterday]   || {};
  const wl = cache.watchlist;

  const signals = [];
  wl.forEach(w => {
    if (isBlackout(w) || isCooldown(w)) return;
    const r7cur  = todayScan[w.ticker + '_r7']  ?? '';
    const r14cur = todayScan[w.ticker + '_r14'] ?? '';
    const r7prev = yesterScan[w.ticker + '_r7'] ?? '';
    const sig = computeSignal(w, { rsi7: r7cur, rsi7prev: r7prev, rsi14: r14cur });
    if (sig !== 'none') signals.push({ w, sig, r7: r7cur, r14: r14cur, r7prev });
  });

  // Sort: SIGNAL first, then WATCH
  signals.sort((a,b) => {
    const rank = s => s.includes('SIGNAL') ? 0 : 1;
    return rank(a.sig) - rank(b.sig);
  });

  const el = document.getElementById('signalsSection');
  const dateEl = document.getElementById('signalsDate');
  if (dateEl) dateEl.textContent = new Date().toLocaleDateString('ru-RU',{weekday:'short',day:'2-digit',month:'short'});

  if (!signals.length) {
    el.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-t" style="font-family:var(--mono);font-size:11px">–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ RSI –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–°–ø–∏—Å–æ–∫¬ª</div></div>';
    return;
  }

  el.innerHTML = signals.map(({ w, sig, r7, r14, r7prev }) => {
    const isSignal = sig.includes('SIGNAL');
    const isLong   = sig.includes('LONG');
    const cls      = isSignal ? (isLong ? 'long' : 'short') : 'watch';

    const label = sig === 'LONG_SIGNAL'  ? 'üü¢ –õ–û–ù–ì ‚Üí –í–•–û–î T0 (—Å–µ–≥–æ–¥–Ω—è)'
                : sig === 'SHORT_SIGNAL' ? 'üî¥ –®–û–†–¢ ‚Üí –í–•–û–î T0 (—Å–µ–≥–æ–¥–Ω—è)'
                : sig === 'WATCH_LONG'   ? 'üëÄ –ù–ê–ë–õ–Æ–î–ê–ï–ú –õ–û–ù–ì'
                :                          'üëÄ –ù–ê–ë–õ–Æ–î–ê–ï–ú –®–û–†–¢';

    return `<div class="sig-card ${cls}">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:17px;font-weight:800">${w.ticker}</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--t2)">${w.sector||''}</span>
      </div>
      <div style="font-family:var(--mono);font-size:11px;font-weight:700;${isSignal?'color:var(--text)':'color:var(--t2)'}">${label}</div>
      <div style="display:flex;gap:14px;font-family:var(--mono);font-size:10px;color:var(--t2)">
        <span>RSI7: <span style="color:${getRsiColor(parseFloat(r7))};font-weight:700">${r7||'‚Äî'}</span></span>
        <span>RSI14: <span style="color:${getRsiColor(parseFloat(r14))};font-weight:700">${r14||'‚Äî'}</span></span>
        <span>RSI7 T-1: <span style="color:var(--text)">${r7prev||'‚Äî'}</span></span>
      </div>
      ${isSignal ? `<button class="btn btn-p btn-s" onclick="openTrade();setTimeout(()=>{document.getElementById('te_tk').value='${w.ticker}';document.getElementById('te_r7').value='${r7}';document.getElementById('te_r14').value='${r14}';},50)">+ –°–î–ï–õ–ö–ê T0</button>` : ''}
    </div>`;
  }).join('');
}

function getPrevDate(dateStr) {
  const d = new Date(dateStr);
  // Step back skipping weekends AND holidays
  do { 
    d.setDate(d.getDate() - 1); 
  } while (!isTradingDay(d.toISOString().split('T')[0]));
  return d.toISOString().split('T')[0];
}

// Get next trading day
function getNextTradingDay(dateStr) {
  const d = new Date(dateStr);
  do { 
    d.setDate(d.getDate() + 1); 
  } while (!isTradingDay(d.toISOString().split('T')[0]));
  return d.toISOString().split('T')[0];
}

// Check if tomorrow is a holiday (for warnings)
function isTomorrowHoliday() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const dateStr = tomorrow.toISOString().split('T')[0];
  return isHoliday(dateStr);
}

// Get holiday name
function getHolidayName(dateStr) {
  const names = {
    '01-01': '–ù–æ–≤—ã–π –≥–æ–¥', '01-19': '–î–µ–Ω—å MLK', '01-20': '–î–µ–Ω—å MLK',
    '02-16': '–î–µ–Ω—å –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤', '02-17': '–î–µ–Ω—å –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤',
    '04-03': '–°—Ç—Ä–∞—Å—Ç–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞', '04-18': '–°—Ç—Ä–∞—Å—Ç–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞',
    '05-25': '–î–µ–Ω—å –ø–∞–º—è—Ç–∏', '05-26': '–î–µ–Ω—å –ø–∞–º—è—Ç–∏',
    '06-19': 'Juneteenth',
    '07-03': '–î–µ–Ω—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏', '07-04': '–î–µ–Ω—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏',
    '09-01': '–î–µ–Ω—å —Ç—Ä—É–¥–∞', '09-07': '–î–µ–Ω—å —Ç—Ä—É–¥–∞',
    '11-26': '–î–µ–Ω—å –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω–∏—è', '11-27': '–î–µ–Ω—å –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω–∏—è',
    '12-24': '–†–æ–∂–¥–µ—Å—Ç–≤–æ', '12-25': '–†–æ–∂–¥–µ—Å—Ç–≤–æ'
  };
  const md = dateStr.slice(5); // MM-DD
  return names[md] || '–ü—Ä–∞–∑–¥–Ω–∏–∫';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Q_CHECKS = [
  '–û–±—ä—ë–º –≤—Å–µ—Ö –∞–∫—Ü–∏–π > $200 –º–ª–Ω/–¥–µ–Ω—å','30-–¥–Ω–µ–≤–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω > 12%','RSI(14) –¥–∏–∞–ø–∞–∑–æ–Ω > 50 –ø—Ç –∑–∞ 90 –¥–Ω–µ–π',
  '–ë–µ—Ç–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.9‚Äì2.5','–£–¥–∞–ª–∏—Ç—å –∞–∫—Ü–∏–∏ —Å 2+ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞–º–∏ –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª',
  '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∞–∫—Ü–∏–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º','–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å 40‚Äì50 –∞–∫—Ü–∏–π –≤ —Å–ø–∏—Å–∫–µ',
  '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã –∫—É–ª–¥–∞—É–Ω–∞','–ù–µ –±–æ–ª–µ–µ 40% –≤ –æ–¥–Ω–æ–º —Å–µ–∫—Ç–æ—Ä–µ','–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é JSON'
];
let qOff = 0;

function qKey(off=0){ const d=new Date(); d.setMonth(d.getMonth()+off*3); return `Q${Math.floor(d.getMonth()/3)+1}_${d.getFullYear()}`; }
function qLbl(off=0){
  const d=new Date(); d.setMonth(d.getMonth()+off*3);
  const q=Math.floor(d.getMonth()/3)+1;
  const m=[['–Ø–Ω–≤–∞—Ä—å','–ú–∞—Ä—Ç'],['–ê–ø—Ä–µ–ª—å','–ò—é–Ω—å'],['–ò—é–ª—å','–°–µ–Ω—Ç—è–±—Ä—å'],['–û–∫—Ç—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å']];
  return `Q${q} ${d.getFullYear()} ¬∑ ${m[q-1][0]} ‚Äì ${m[q-1][1]}`;
}

function renderQ() {
  const key = qKey(qOff);
  document.getElementById('qLabel').textContent = qLbl(qOff);
  const data = (cache.quarterly||{})[key]||{};
  ['t','wr','r','d','aw','al','rem','add','gd','im','vl','ch'].forEach(f=>{ const el=document.getElementById('q_'+f); if(el) el.value=data[f]||''; });
  document.getElementById('q_ps').value = data.ps||'100';
  const saved = data.checks||{};
  document.getElementById('q-cl').innerHTML = Q_CHECKS.map((txt,i)=>{
    const chk = saved[i]||false;
    return `<div class="ci ${chk?'chk':''}" onclick="toggleQCl(${i},this)">
      <div class="cbox"></div><div class="cit">${txt}</div>
    </div>`;
  }).join('');
}

async function toggleQCl(i,el) {
  el.classList.toggle('chk');
  const key=qKey(qOff);
  if(!cache.quarterly[key]) cache.quarterly[key]={};
  if(!cache.quarterly[key].checks) cache.quarterly[key].checks={};
  cache.quarterly[key].checks[i]=el.classList.contains('chk');
  scheduleSave();
}

async function saveQ() {
  const key=qKey(qOff);
  if(!cache.quarterly[key]) cache.quarterly[key]={};
  const d = cache.quarterly[key];
  ['t','wr','r','d','aw','al','rem','add','gd','im','vl','ch'].forEach(f=>{ const el=document.getElementById('q_'+f); if(el) d[f]=el.value; });
  d.ps = document.getElementById('q_ps').value;
  scheduleSave(); const ok = true;
  if(ok) toast('–ö–≤–∞—Ä—Ç–∞–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMo(id){ document.getElementById(id).classList.add('open'); }
function closeMo(id){ document.getElementById(id).classList.remove('open'); }
document.addEventListener('click',e=>{ if(e.target.classList.contains('mo')) e.target.classList.remove('open'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT / CLEAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON() {
  const data = { 
    trades: cache.trades, 
    watchlist: cache.watchlist, 
    quarterly: cache.quarterly, 
    checklist: cache.checklist, 
    settings: cache.settings, 
    regime: cache.regime, 
    rsiScans: cache.rsiScans,
    exportedAt: new Date().toISOString() 
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`rsi-journal-backup-${today()}.json`; a.click();
  URL.revokeObjectURL(url); toast('JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω ‚úì');
}

function importJSON(e) {
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      confirmDialog('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?', async () => {
        if(data.trades)    cache.trades    = data.trades;
        if(data.watchlist) cache.watchlist = data.watchlist;
        if(data.quarterly) cache.quarterly = data.quarterly;
        if(data.checklist) cache.checklist = data.checklist;
        if(data.settings)  cache.settings  = data.settings;
        if(data.regime)    cache.regime    = data.regime;
        if(data.rsiScans)  cache.rsiScans  = data.rsiScans;
        await persistToCloud();
        renderDash(); renderTrades(); renderWL(); renderQ(); initChecklist(); loadSetsUI(); renderHolidays(); renderRsiScan();
        toast('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úì');
      });
    } catch { toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞!', true); }
  };
  r.readAsText(file);
}

function clearCloud() {
  confirmDialog('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!', async () => {
    await cloudDel();
    Object.assign(cache,{trades:[],watchlist:[],quarterly:{},checklist:{},settings:{...DEF_SETS},regime:{}});
    renderDash(); renderTrades(); renderWL(); renderQ(); initChecklist(); loadSetsUI(); renderHolidays();
    setSyncState('synced','–û–ß–ò–©–ï–ù–û');
    toast('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function today(){ return new Date().toISOString().split('T')[0]; }

// Aliases for legacy calls
async function persistToCloud() { return doSave(); }
async function saveCloud()      { scheduleSave(); return true; }
async function cloudDel() {
  try { localStorage.removeItem(LS_KEY); } catch {}
  try { sessionStorage.removeItem(SS_KEY); } catch {}
  // Optionally wipe Gist content
  const { token, gistId } = getGhCreds();
  if (token && gistId) {
    try {
      await fetch(`https://api.github.com/gists/${gistId}`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: { 'rsi-journal.json': { content: '{}' } } })
      });
    } catch {}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  // Step 1: render immediately from localStorage (zero delay)
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) applyData(JSON.parse(raw));
  } catch {}

  if (!cache.settings || !Object.keys(cache.settings).length) cache.settings = {...DEF_SETS};
  if (!cache.settings.finnhubKey) cache.settings.finnhubKey = FINNHUB_KEY;

  try { document.getElementById('hdrDate').textContent = today(); } catch {}

  loadSetsUI(); loadGhUI(); loadFhKeyUI(); initChecklist(); renderHolidays();
  renderDash(); renderTrades(); renderWL(); renderQ(); renderRsiScan();

  const rsi = cache.regime?.spyRsi14;
  if (rsi) { try { document.getElementById('spyRsi').value = rsi; updRegime(false); } catch {} }

  setSyncState('synced', storageModeLabel());
  updateStorageInfo();

  // Step 2: sync from GitHub in background (non-blocking)
  const token = getToken();
  if (token) {
    setSyncState('syncing', '–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...');
    try {
      const controller = new AbortController();
      const tid = setTimeout(() => controller.abort(), 8000);
      const res = await fetch(ghRAW() + '?t=' + Date.now(), { signal: controller.signal });
      clearTimeout(tid);

      if (res.ok) {
        const text = await res.text();
        const trimmed = text.trim();
        if (trimmed && trimmed !== '{}') {
          const data = JSON.parse(trimmed);
          applyData(data);
          storageMode = 'github';
          try { localStorage.setItem(LS_KEY, trimmed); } catch {}
          loadSetsUI(); loadGhUI(); loadFhKeyUI(); initChecklist(); renderHolidays();
          renderDash(); renderTrades(); renderWL(); renderQ(); renderRsiScan();
          fetchGhSha(token);
        }
      }
    } catch(e) {
      if (e.name !== 'AbortError') console.warn('bg sync:', e.message);
    }
    setSyncState('synced', storageModeLabel());
    updateStorageInfo();
  }
}

init();
</script>
</body>
</html>
